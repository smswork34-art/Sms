<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS Mailing - Мини-приложение</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0088cc 0%, #34b7f1 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        .app-header {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 136, 204, 0.2);
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #0088cc, #34b7f1);
            border-radius: 20px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
        }

        h1 {
            color: #0088cc;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .prices {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .price-badge {
            background: #f0f9ff;
            padding: 8px 15px;
            border-radius: 10px;
            color: #0088cc;
            font-weight: 600;
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 136, 204, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-title {
            color: #0088cc;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            font-size: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #0088cc, #34b7f1);
            color: white;
            border: none;
            padding: 16px 25px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: linear-gradient(135deg, #0077b3, #2aa8e0);
            box-shadow: 0 5px 15px rgba(0, 136, 204, 0.3);
        }

        .btn:disabled {
            background: #cccccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .btn-secondary {
            background: white;
            color: #0088cc;
            border: 2px solid #0088cc;
        }

        .btn-secondary:hover {
            background: #f0f9ff;
        }

        .btn-success {
            background: linear-gradient(135deg, #00c851, #5eff8f);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #00b347, #4cff7a);
        }

        .btn-admin {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
        }

        .btn-admin:hover {
            background: linear-gradient(135deg, #7d3c98, #8e44ad);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4444, #ff8888);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #dd3333, #ff6666);
        }

        .balance-card {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .balance-item {
            background: linear-gradient(135deg, #f0f9ff, #e1f5fe);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid #d1ecff;
        }

        .currency {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .amount {
            font-size: 32px;
            font-weight: 700;
            color: #0088cc;
        }

        .currency-symbol {
            font-size: 20px;
            margin-right: 2px;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            color: white;
            font-size: 20px;
            margin-bottom: 15px;
            padding-left: 10px;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #0088cc;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .nav-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-around;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: #666;
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 100px;
        }

        .nav-btn:hover {
            background: #f0f9ff;
            color: #0088cc;
        }

        .nav-btn.active {
            color: #0088cc;
            background: #f0f9ff;
        }

        .nav-btn i {
            font-size: 22px;
        }

        .nav-btn span {
            font-size: 12px;
            font-weight: 500;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-type {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .history-icon.deposit {
            background: linear-gradient(135deg, #00c851, #5eff8f);
        }

        .history-icon.payment {
            background: linear-gradient(135deg, #ff4444, #ff8888);
        }

        .history-details h4 {
            color: #333;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .history-details p {
            color: #666;
            font-size: 14px;
        }

        .history-amount {
            text-align: right;
        }

        .history-amount .amount {
            font-size: 18px;
            font-weight: 600;
        }

        .history-amount .currency {
            font-size: 12px;
            color: #999;
        }

        .deposit-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .deposit-option {
            background: linear-gradient(135deg, #f8fdff, #e6f7ff);
            border: 2px solid #d1ecff;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .deposit-option:hover {
            background: linear-gradient(135deg, #e6f7ff, #d4f1ff);
            border-color: #0088cc;
            transform: translateY(-3px);
        }

        .deposit-option.active {
            background: linear-gradient(135deg, #0088cc, #34b7f1);
            border-color: #0088cc;
            color: white;
        }

        .deposit-option.active .currency {
            color: white;
        }

        .deposit-option i {
            font-size: 32px;
            margin-bottom: 10px;
            color: #0088cc;
        }

        .deposit-option.active i {
            color: white;
        }

        .deposit-option .currency {
            font-size: 18px;
            font-weight: 600;
            color: #0088cc;
            margin-bottom: 5px;
        }

        .deposit-option.active .currency {
            color: white;
        }

        .deposit-amounts {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .amount-btn {
            background: white;
            border: 2px solid #d1ecff;
            border-radius: 10px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #0088cc;
        }

        .amount-btn:hover {
            background: #f0f9ff;
            border-color: #0088cc;
        }

        .amount-btn.active {
            background: #0088cc;
            color: white;
            border-color: #0088cc;
        }

        .custom-amount {
            margin-top: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #0088cc;
            font-weight: 500;
        }

        input, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #d1ecff;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #0088cc;
            box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.1);
        }

        .info-box {
            background: #f0f9ff;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #0088cc;
        }

        .info-box p {
            color: #333;
            font-size: 14px;
            line-height: 1.5;
        }

        .address-box {
            background: #f8fdff;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 2px dashed #0088cc;
            word-break: break-all;
            font-family: monospace;
            font-size: 14px;
            color: #333;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #0088cc;
        }

        .loading i {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .hash-input-section {
            margin-top: 20px;
            display: none;
        }

        .hash-input-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(142, 68, 173, 0.2);
            text-align: center;
        }

        .admin-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            border-radius: 15px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: white;
        }

        .admin-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .admin-stat-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(142, 68, 173, 0.1);
        }

        .admin-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #8e44ad;
            margin-bottom: 5px;
        }

        .admin-stat-label {
            font-size: 14px;
            color: #666;
        }

        .admin-menu {
            display: grid;
            gap: 10px;
        }

        .admin-btn {
            background: white;
            border: 2px solid #e6d0f1;
            border-radius: 12px;
            padding: 18px 20px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .admin-btn:hover {
            background: #f9f0ff;
            border-color: #8e44ad;
            transform: translateY(-2px);
        }

        .admin-btn i {
            font-size: 20px;
            color: #8e44ad;
        }

        .user-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .user-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info h4 {
            color: #333;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .user-info p {
            color: #666;
            font-size: 14px;
        }

        .user-balance {
            text-align: right;
        }

        .user-balance .amount {
            font-size: 18px;
            font-weight: 600;
            color: #8e44ad;
        }

        .user-balance .currency {
            font-size: 12px;
            color: #999;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 10px;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-approved {
            background: #d4edda;
            color: #155724;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }

        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }

        .status-cancelled {
            background: #f8d7da;
            color: #721c24;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #home {
            padding-top: 10px;
            padding-bottom: 20px;
        }

        .app-header {
            margin-top: 10px;
        }

        .requests-grid {
            display: grid;
            gap: 15px;
            margin-bottom: 20px;
        }

        .request-item {
            background: white;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid #d1ecff;
            box-shadow: 0 3px 10px rgba(0, 136, 204, 0.1);
        }

        .request-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .request-id {
            font-weight: 600;
            color: #0088cc;
            font-size: 16px;
        }

        .request-user {
            font-size: 14px;
            color: #666;
        }

        .request-date {
            font-size: 12px;
            color: #999;
        }

        .request-numbers {
            margin-bottom: 15px;
        }

        .request-numbers h4 {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .numbers-list {
            background: #f8fdff;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            border: 1px solid #d1ecff;
            max-height: 100px;
            overflow-y: auto;
        }

        .request-text {
            margin-bottom: 15px;
        }

        .request-text h4 {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .text-content {
            background: #f8fdff;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px;
            color: #333;
            border: 1px solid #d1ecff;
            line-height: 1.4;
            max-height: 150px;
            overflow-y: auto;
        }

        .request-cost {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            padding: 10px;
            background: #f0f9ff;
            border-radius: 8px;
        }

        .cost-item {
            text-align: center;
        }

        .cost-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 3px;
        }

        .cost-value {
            font-size: 16px;
            font-weight: 600;
            color: #0088cc;
        }

        .request-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 15px;
            border-radius: 8px;
            border: 2px solid #d1ecff;
            background: white;
            color: #0088cc;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: #0088cc;
            color: white;
            border-color: #0088cc;
        }

        .filter-btn:hover {
            background: #f0f9ff;
        }

        .transaction-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .transaction-type {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .transaction-icon.deposit {
            background: linear-gradient(135deg, #00c851, #5eff8f);
        }

        .transaction-icon.payment {
            background: linear-gradient(135deg, #ff4444, #ff8888);
        }

        .transaction-details h4 {
            color: #333;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .transaction-details p {
            color: #666;
            font-size: 14px;
        }

        .transaction-amount {
            text-align: right;
        }

        .transaction-amount .amount {
            font-size: 18px;
            font-weight: 600;
        }

        .transaction-amount .currency {
            font-size: 12px;
            color: #999;
        }

        .sync-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 12px;
            margin-top: 10px;
            color: #666;
        }

        .sync-status.synced {
            color: #00c851;
        }

        .sync-status.error {
            color: #ff4444;
        }

        .sync-btn {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #0088cc, #34b7f1);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            box-shadow: 0 4px 15px rgba(0, 136, 204, 0.3);
            z-index: 100;
        }

        .sync-btn:hover {
            background: linear-gradient(135deg, #0077b3, #2aa8e0);
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .app-header {
                padding: 20px;
            }
            
            .balance-card {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .deposit-amounts {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .admin-stats-grid {
                grid-template-columns: 1fr;
            }
            
            .request-actions {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Главная страница -->
        <div class="page active" id="home">
            <div class="app-header">
                <div class="logo">
                    <i class="fas fa-sms"></i>
                </div>
                <h1>SMS Mailing</h1>
                <p class="subtitle">Отправляйте СМС рассылки быстро и удобно. Идеально для бизнеса и уведомлений.</p>
                <div class="prices">
                    <div class="price-badge">
                        <i class="fas fa-gem"></i> 1 СМС = 1 USDT
                    </div>
                    <div class="price-badge">
                        <i class="fas fa-bolt"></i> 1 СМС = 0.65 TON
                    </div>
                </div>
            </div>

            <div class="balance-card">
                <div class="balance-item">
                    <div class="currency">
                        <i class="fas fa-gem"></i> USDT
                    </div>
                    <div class="amount">
                        <span class="currency-symbol">$</span>
                        <span id="balance-usdt">0.00</span>
                    </div>
                </div>
                <div class="balance-item">
                    <div class="currency">
                        <i class="fas fa-bolt"></i> TON
                    </div>
                    <div class="amount">
                        <span class="currency-symbol">⏣</span>
                        <span id="balance-ton">0.00</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Быстрые действия</h2>
                <button class="btn" id="mailing-btn" onclick="showPage('mailing')">
                    <i class="fas fa-paper-plane"></i>
                    Запустить рассылку
                </button>
                <button class="btn btn-secondary" onclick="showPage('deposit')">
                    <i class="fas fa-wallet"></i>
                    Пополнить баланс
                </button>
                <button class="btn btn-admin" id="admin-btn" onclick="checkAdminAccess()">
                    <i class="fas fa-user-shield"></i>
                    Админ панель
                </button>
            </div>

            <div class="section">
                <h2 class="section-title">Статистика</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-sms">0</div>
                        <div class="stat-label">Всего СМС</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-cost">0</div>
                        <div class="stat-label">Общая стоимость</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="success-rate">0%</div>
                        <div class="stat-label">Успешных</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pending">0</div>
                        <div class="stat-label">В ожидании</div>
                    </div>
                </div>
            </div>
            
            <div class="sync-status" id="sync-status">
                <i class="fas fa-sync-alt"></i>
                <span>Синхронизация...</span>
            </div>
        </div>

        <!-- Страница рассылки -->
        <div class="page" id="mailing">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-paper-plane"></i>
                    Новая рассылка
                </div>
                
                <div class="input-group">
                    <label for="phone-numbers">
                        <i class="fas fa-phone"></i> Номера телефонов
                    </label>
                    <textarea 
                        id="phone-numbers" 
                        rows="5" 
                        placeholder="Введите номера через точку с запятой:
+79991234567;
89991234567;
79001234567;"
                    ></textarea>
                </div>

                <div class="input-group">
                    <label for="sms-text">
                        <i class="fas fa-comment-alt"></i> Текст СМС
                    </label>
                    <textarea 
                        id="sms-text" 
                        rows="4" 
                        placeholder="Введите текст сообщения..."
                        maxlength="1600"
                    ></textarea>
                    <div style="text-align: right; margin-top: 5px; font-size: 14px; color: #666;">
                        <span id="char-count">0</span>/1600 символов
                    </div>
                </div>

                <div class="info-box">
                    <p><strong>Формат номеров:</strong><br>
                    • Начинаются на +7, 7 или 8<br>
                    • Разделяются точкой с запятой (;)<br>
                    • Каждый номер с новой строки</p>
                </div>

                <div class="info-box">
                    <p><strong>Стоимость:</strong><br>
                    • 1 номер = 1 USDT или 0.65 TON<br>
                    • К оплате: <span id="sms-cost">0</span> USDT / <span id="sms-cost-ton">0</span> TON</p>
                </div>

                <button class="btn" id="submit-mailing-btn" onclick="submitMailing()">
                    <i class="fas fa-paper-plane"></i>
                    Отправить на модерацию
                </button>
                <button class="btn btn-secondary" onclick="showPage('home')">
                    <i class="fas fa-arrow-left"></i>
                    Назад
                </button>
            </div>
        </div>

        <!-- Страница пополнения -->
        <div class="page" id="deposit">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-wallet"></i>
                    Пополнение баланса
                </div>

                <div class="deposit-options">
                    <div class="deposit-option active" onclick="selectCurrency('USDT')">
                        <i class="fas fa-gem"></i>
                        <div class="currency">USDT</div>
                        <div style="font-size: 12px; color: #666;">TRON (TRC20)</div>
                    </div>
                    <div class="deposit-option" onclick="selectCurrency('TON')">
                        <i class="fas fa-bolt"></i>
                        <div class="currency">TON</div>
                        <div style="font-size: 12px; color: #666;">The Open Network</div>
                    </div>
                </div>

                <div class="deposit-amounts">
                    <div class="amount-btn active" onclick="selectAmount(10)">10</div>
                    <div class="amount-btn" onclick="selectAmount(25)">25</div>
                    <div class="amount-btn" onclick="selectAmount(50)">50</div>
                    <div class="amount-btn" onclick="selectAmount(100)">100</div>
                    <div class="amount-btn" onclick="selectAmount(250)">250</div>
                    <div class="amount-btn" onclick="selectCustomAmount()">Другая</div>
                </div>

                <div class="custom-amount" id="custom-amount-section" style="display: none;">
                    <div class="input-group">
                        <label>Сумма пополнения (<span id="selected-currency">USDT</span>)</label>
                        <input 
                            type="number" 
                            id="custom-amount-input" 
                            placeholder="Введите сумму"
                            min="10"
                            step="0.1"
                        >
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            Минимальная сумма: 10 <span id="min-currency">USDT</span>
                        </div>
                    </div>
                </div>

                <div class="info-box" id="deposit-info">
                    <p><strong>USDT (TRON TRC20)</strong><br>
                    Отправьте точную сумму на указанный адрес.<br>
                    Комиссию оплачивает отправитель.</p>
                </div>

                <div class="address-box" id="deposit-address">
                    TJSgjT9n1234567890abcdefghijklmnop
                </div>

                <div class="hash-input-section" id="hash-input-section">
                    <div class="input-group">
                        <label for="tx-hash">
                            <i class="fas fa-hashtag"></i> HASH транзакции
                        </label>
                        <input 
                            type="text" 
                            id="tx-hash" 
                            placeholder="Введите хеш транзакции (например: 0x1234...)"
                        >
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            Скопируйте хеш транзакции из вашего кошелька
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="submitPayment()">
                        <i class="fas fa-check"></i>
                        Отправить на проверку
                    </button>
                </div>

                <button class="btn" onclick="copyAddress()">
                    <i class="fas fa-copy"></i>
                    Скопировать адрес
                </button>
                <button class="btn btn-success" onclick="showHashInput()">
                    <i class="fas fa-money-check-alt"></i>
                    Я оплатил
                </button>
                <button class="btn btn-secondary" onclick="showPage('home')">
                    <i class="fas fa-arrow-left"></i>
                    Назад
                </button>
            </div>
        </div>

        <!-- Страница истории -->
        <div class="page" id="history">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-history"></i>
                    История операций
                </div>
                
                <div id="transactions-list">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Загрузка истории...</p>
                    </div>
                </div>
                
                <button class="btn btn-secondary" onclick="showPage('home')">
                    <i class="fas fa-arrow-left"></i>
                    Назад
                </button>
            </div>
        </div>

        <!-- Страница админ панели -->
        <div class="page" id="admin-panel">
            <div class="admin-header">
                <div class="admin-logo">
                    <i class="fas fa-user-shield"></i>
                </div>
                <h1>Админ панель</h1>
                <p class="subtitle">Управление системой SMS рассылок</p>
                <div class="sync-status" id="admin-sync-status">
                    <i class="fas fa-sync-alt"></i>
                    <span>Синхронизация...</span>
                </div>
            </div>

            <div class="admin-menu">
                <button class="admin-btn" onclick="showAdminSection('all-users')">
                    <i class="fas fa-users"></i>
                    Все пользователи
                    <span id="users-count" style="margin-left: auto; background: #8e44ad; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">0</span>
                </button>
                <button class="admin-btn" onclick="showAdminSection('all-transactions')">
                    <i class="fas fa-exchange-alt"></i>
                    Все транзакции
                    <span id="transactions-count" style="margin-left: auto; background: #8e44ad; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">0</span>
                </button>
                <button class="admin-btn" onclick="showAdminSection('all-mailings')">
                    <i class="fas fa-envelope"></i>
                    Все рассылки
                    <span id="mailings-count" style="margin-left: auto; background: #8e44ad; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">0</span>
                </button>
                <button class="admin-btn" onclick="showAdminSection('payment-requests')">
                    <i class="fas fa-money-check-alt"></i>
                    Запросы на пополнение
                    <span id="payments-count" style="margin-left: auto; background: #8e44ad; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px;">0</span>
                </button>
                <button class="admin-btn" onclick="showAdminSection('stats')">
                    <i class="fas fa-chart-bar"></i>
                    Статистика системы
                </button>
                <button class="admin-btn" onclick="downloadBackup()">
                    <i class="fas fa-download"></i>
                    Скачать бэкап данных
                </button>
                <button class="admin-btn" onclick="syncAllData()">
                    <i class="fas fa-sync-alt"></i>
                    Принудительная синхронизация
                </button>
            </div>

            <div id="admin-content" style="margin-top: 20px;">
                <!-- Контент будет загружаться динамически -->
            </div>

            <button class="btn btn-secondary" onclick="showPage('home')" style="margin-top: 20px;">
                <i class="fas fa-arrow-left"></i>
                На главную
            </button>
        </div>

        <!-- Нижняя навигация -->
        <div class="nav-bottom">
            <button class="nav-btn active" onclick="showPage('home')">
                <i class="fas fa-home"></i>
                <span>Главная</span>
            </button>
            <button class="nav-btn" onclick="showPage('mailing')">
                <i class="fas fa-paper-plane"></i>
                <span>Рассылка</span>
            </button>
            <button class="nav-btn" onclick="showPage('deposit')">
                <i class="fas fa-wallet"></i>
                <span>Пополнение</span>
            </button>
            <button class="nav-btn" onclick="showPage('history')">
                <i class="fas fa-history"></i>
                <span>История</span>
            </button>
        </div>

        <!-- Кнопка синхронизации -->
        <button class="sync-btn" onclick="syncAllData()" title="Синхронизировать данные">
            <i class="fas fa-sync-alt"></i>
        </button>
    </div>

    <script>
        // ========== КОНФИГУРАЦИЯ ==========
        const ADMIN_TELEGRAM_ID = 6864759899; // Ваш ID администратора
        
        // ========== ТЕЛЕГРАМ CLOUD STORAGE СИСТЕМА ==========
        class Database {
            constructor() {
                this.tg = window.Telegram.WebApp;
                this.isReady = false;
                this.lastSync = 0;
                this.SYNC_INTERVAL = 30000; // 30 секунд
            }
            
            async init() {
                try {
                    // Проверяем доступность Cloud Storage
                    if (this.tg && this.tg.CloudStorage) {
                        console.log('Telegram Cloud Storage доступен');
                        await this.syncFromCloud();
                        this.isReady = true;
                        
                        // Автосинхронизация каждые 30 секунд
                        setInterval(() => this.syncToCloud(), this.SYNC_INTERVAL);
                        
                        return true;
                    } else {
                        console.log('Telegram Cloud Storage недоступен, используем localStorage');
                        this.loadFromLocalStorage();
                        this.isReady = true;
                        return false;
                    }
                } catch (error) {
                    console.error('Ошибка инициализации БД:', error);
                    this.loadFromLocalStorage();
                    this.isReady = true;
                    return false;
                }
            }
            
            // Загрузка из localStorage
            loadFromLocalStorage() {
                try {
                    // Загрузка всех пользователей
                    const usersData = localStorage.getItem('sms_mailing_users');
                    this.users = usersData ? JSON.parse(usersData) : {};
                    
                    // Загрузка всех запросов на рассылку
                    const requestsData = localStorage.getItem('sms_mailing_requests');
                    this.mailingRequests = requestsData ? JSON.parse(requestsData) : [];
                    
                    // Загрузка всех платежей
                    const paymentsData = localStorage.getItem('sms_mailing_payments');
                    this.payments = paymentsData ? JSON.parse(paymentsData) : [];
                    
                    // Загрузка статистики
                    const statsData = localStorage.getItem('sms_mailing_stats');
                    this.stats = statsData ? JSON.parse(statsData) : {
                        totalSMS: 0,
                        totalCost: 0,
                        successful: 0,
                        rejected: 0,
                        pending: 0,
                        totalRevenue: 0,
                        lastUpdate: new Date().toISOString()
                    };
                    
                    console.log('Данные загружены из localStorage');
                } catch (error) {
                    console.error('Ошибка загрузки из localStorage:', error);
                    this.resetData();
                }
            }
            
            // Синхронизация с Telegram Cloud Storage
            async syncToCloud() {
                try {
                    if (!this.tg?.CloudStorage) return false;
                    
                    const dataToSync = {
                        users: this.users,
                        mailingRequests: this.mailingRequests,
                        payments: this.payments,
                        stats: this.stats,
                        lastSync: new Date().toISOString()
                    };
                    
                    // Разбиваем данные на части (Telegram Cloud Storage имеет ограничения)
                    const dataStr = JSON.stringify(dataToSync);
                    const chunks = this.splitString(dataStr, 4000); // Разбиваем на части по 4000 символов
                    
                    // Сохраняем количество чанков
                    await this.tg.CloudStorage.setItem('chunks_count', chunks.length.toString());
                    
                    // Сохраняем каждый чанк
                    for (let i = 0; i < chunks.length; i++) {
                        await this.tg.CloudStorage.setItem(`chunk_${i}`, chunks[i]);
                    }
                    
                    this.lastSync = Date.now();
                    console.log('Данные синхронизированы с Telegram Cloud');
                    updateSyncStatus(true, 'Синхронизировано');
                    return true;
                } catch (error) {
                    console.error('Ошибка синхронизации с облаком:', error);
                    updateSyncStatus(false, 'Ошибка синхронизации');
                    return false;
                }
            }
            
            // Загрузка из Telegram Cloud Storage
            async syncFromCloud() {
                try {
                    if (!this.tg?.CloudStorage) return false;
                    
                    // Получаем количество чанков
                    const chunksCount = await this.tg.CloudStorage.getItem('chunks_count');
                    if (!chunksCount) {
                        console.log('Нет данных в облаке');
                        return false;
                    }
                    
                    // Собираем все чанки
                    let dataStr = '';
                    for (let i = 0; i < parseInt(chunksCount); i++) {
                        const chunk = await this.tg.CloudStorage.getItem(`chunk_${i}`);
                        if (chunk) {
                            dataStr += chunk;
                        }
                    }
                    
                    if (!dataStr) {
                        console.log('Пустые данные в облаке');
                        return false;
                    }
                    
                    // Парсим данные
                    const data = JSON.parse(dataStr);
                    this.users = data.users || {};
                    this.mailingRequests = data.mailingRequests || [];
                    this.payments = data.payments || [];
                    this.stats = data.stats || {
                        totalSMS: 0,
                        totalCost: 0,
                        successful: 0,
                        rejected: 0,
                        pending: 0,
                        totalRevenue: 0,
                        lastUpdate: new Date().toISOString()
                    };
                    
                    // Сохраняем в localStorage как резервную копию
                    this.saveToLocalStorage();
                    
                    console.log('Данные загружены из Telegram Cloud');
                    return true;
                } catch (error) {
                    console.error('Ошибка загрузки из облака:', error);
                    this.loadFromLocalStorage();
                    return false;
                }
            }
            
            // Сохранение в localStorage
            saveToLocalStorage() {
                try {
                    localStorage.setItem('sms_mailing_users', JSON.stringify(this.users));
                    localStorage.setItem('sms_mailing_requests', JSON.stringify(this.mailingRequests));
                    localStorage.setItem('sms_mailing_payments', JSON.stringify(this.payments));
                    localStorage.setItem('sms_mailing_stats', JSON.stringify(this.stats));
                } catch (error) {
                    console.error('Ошибка сохранения в localStorage:', error);
                }
            }
            
            // Вспомогательная функция для разбиения строки
            splitString(str, size) {
                const chunks = [];
                for (let i = 0; i < str.length; i += size) {
                    chunks.push(str.slice(i, i + size));
                }
                return chunks;
            }
            
            // Сброс данных
            resetData() {
                this.users = {};
                this.mailingRequests = [];
                this.payments = [];
                this.stats = {
                    totalSMS: 0,
                    totalCost: 0,
                    successful: 0,
                    rejected: 0,
                    pending: 0,
                    totalRevenue: 0,
                    lastUpdate: new Date().toISOString()
                };
                this.saveToLocalStorage();
            }
            
            // ========== МЕТОДЫ ДЛЯ РАБОТЫ С ДАННЫМИ ==========
            
            // Получение текущего пользователя
            getCurrentUser() {
                if (this.tg?.initDataUnsafe?.user) {
                    const tgUser = this.tg.initDataUnsafe.user;
                    const userId = tgUser.id.toString();
                    
                    // Если пользователь еще не сохранен, добавляем его
                    if (!this.users[userId]) {
                        this.users[userId] = {
                            id: userId,
                            username: tgUser.username || `user_${userId}`,
                            firstName: tgUser.first_name || 'Пользователь',
                            lastName: tgUser.last_name || '',
                            languageCode: tgUser.language_code || 'ru',
                            balance: { usdt: 0, ton: 0 },
                            mailings: 0,
                            deposits: 0,
                            registrationDate: new Date().toLocaleString('ru-RU'),
                            lastActive: new Date().toISOString()
                        };
                        this.saveToLocalStorage();
                        this.syncToCloud();
                    } else {
                        // Обновляем время последней активности
                        this.users[userId].lastActive = new Date().toISOString();
                    }
                    
                    return this.users[userId];
                }
                
                // Для тестирования без Telegram
                return {
                    id: 'test_123456',
                    username: 'test_user',
                    firstName: 'Тестовый',
                    lastName: 'Пользователь',
                    languageCode: 'ru',
                    balance: { usdt: 100, ton: 50 },
                    mailings: 0,
                    deposits: 0,
                    registrationDate: new Date().toLocaleString('ru-RU'),
                    lastActive: new Date().toISOString()
                };
            }
            
            // Получение баланса пользователя
            getUserBalance(userId) {
                const user = this.users[userId];
                return user ? user.balance : { usdt: 0, ton: 0 };
            }
            
            // Обновление баланса пользователя
            updateUserBalance(userId, currency, amount, isAddition = true) {
                if (!this.users[userId]) {
                    this.users[userId] = {
                        id: userId,
                        username: `user_${userId}`,
                        firstName: 'Пользователь',
                        balance: { usdt: 0, ton: 0 },
                        mailings: 0,
                        deposits: 0,
                        registrationDate: new Date().toLocaleString('ru-RU'),
                        lastActive: new Date().toISOString()
                    };
                }
                
                const user = this.users[userId];
                
                if (currency === 'USDT') {
                    if (isAddition) {
                        user.balance.usdt += amount;
                        user.deposits = (user.deposits || 0) + amount;
                    } else {
                        user.balance.usdt -= amount;
                        user.mailings = (user.mailings || 0) + 1;
                    }
                } else if (currency === 'TON') {
                    if (isAddition) {
                        user.balance.ton += amount;
                        user.deposits = (user.deposits || 0) + amount;
                    } else {
                        user.balance.ton -= amount;
                        user.mailings = (user.mailings || 0) + 1;
                    }
                }
                
                user.lastActive = new Date().toISOString();
                
                this.saveToLocalStorage();
                this.syncToCloud();
                
                return user.balance;
            }
            
            // Добавление запроса на рассылку
            addMailingRequest(request) {
                this.mailingRequests.push(request);
                this.saveToLocalStorage();
                this.syncToCloud();
                return request.id;
            }
            
            // Добавление платежа
            addPayment(payment) {
                this.payments.push(payment);
                this.saveToLocalStorage();
                this.syncToCloud();
                return payment.id;
            }
            
            // Обновление статистики
            updateStats(newStats) {
                this.stats = { ...this.stats, ...newStats, lastUpdate: new Date().toISOString() };
                this.saveToLocalStorage();
                this.syncToCloud();
            }
            
            // Получение всех пользователей
            getAllUsers() {
                return this.users;
            }
            
            // Получение всех запросов на рассылку
            getAllMailingRequests() {
                return this.mailingRequests;
            }
            
            // Получение всех платежей
            getAllPayments() {
                return this.payments;
            }
            
            // Получение статистики
            getStats() {
                return this.stats;
            }
            
            // Поиск запроса на рассылку по ID
            findMailingRequestById(id) {
                return this.mailingRequests.find(r => r.id === id);
            }
            
            // Поиск платежа по ID
            findPaymentById(id) {
                return this.payments.find(p => p.id === id);
            }
            
            // Обновление запроса на рассылку
            updateMailingRequest(id, updates) {
                const index = this.mailingRequests.findIndex(r => r.id === id);
                if (index !== -1) {
                    this.mailingRequests[index] = { ...this.mailingRequests[index], ...updates };
                    this.saveToLocalStorage();
                    this.syncToCloud();
                    return true;
                }
                return false;
            }
            
            // Обновление платежа
            updatePayment(id, updates) {
                const index = this.payments.findIndex(p => p.id === id);
                if (index !== -1) {
                    this.payments[index] = { ...this.payments[index], ...updates };
                    this.saveToLocalStorage();
                    this.syncToCloud();
                    return true;
                }
                return false;
            }
            
            // Получение данных для бэкапа
            getBackupData() {
                return {
                    users: this.users,
                    mailingRequests: this.mailingRequests,
                    payments: this.payments,
                    stats: this.stats,
                    backupDate: new Date().toISOString(),
                    totalUsers: Object.keys(this.users).length,
                    totalMailings: this.mailingRequests.length,
                    totalPayments: this.payments.length
                };
            }
            
            // Импорт данных из бэкапа
            importBackupData(backupData) {
                if (backupData.users) this.users = backupData.users;
                if (backupData.mailingRequests) this.mailingRequests = backupData.mailingRequests;
                if (backupData.payments) this.payments = backupData.payments;
                if (backupData.stats) this.stats = backupData.stats;
                
                this.saveToLocalStorage();
                this.syncToCloud();
                
                return true;
            }
        }
        
        // ========== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ==========
        const db = new Database();
        const tg = window.Telegram.WebApp;
        let appState = {
            selectedCurrency: 'USDT',
            selectedAmount: 10,
            isAdmin: false
        };
        
        // ========== ИНИЦИАЛИЗАЦИЯ ==========
        document.addEventListener('DOMContentLoaded', async function() {
            // Инициализируем Telegram WebApp
            tg.expand();
            tg.MainButton.hide();
            
            // Инициализируем базу данных
            await db.init();
            
            // Проверяем статус администратора
            checkAdminStatus();
            
            // Загружаем данные пользователя
            loadUserData();
            
            // Настраиваем обработчики событий
            setupEventListeners();
            
            // Обновляем кнопку рассылки
            updateMailingButton();
            
            // Обновляем статус синхронизации
            updateSyncStatus(true, 'Готово');
        });
        
        function setupEventListeners() {
            const smsText = document.getElementById('sms-text');
            const phoneNumbers = document.getElementById('phone-numbers');
            const customAmountInput = document.getElementById('custom-amount-input');
            
            if (smsText) {
                smsText.addEventListener('input', function() {
                    document.getElementById('char-count').textContent = this.value.length;
                    updateSMSCost();
                    updateSubmitButton();
                });
            }
            
            if (phoneNumbers) {
                phoneNumbers.addEventListener('input', function() {
                    updateSMSCost();
                    updateSubmitButton();
                });
            }
            
            if (customAmountInput) {
                customAmountInput.addEventListener('input', function() {
                    const amount = parseFloat(this.value) || 0;
                    if (amount >= 10) {
                        appState.selectedAmount = amount;
                    }
                });
            }
        }
        
        function updateSyncStatus(isSuccess, message) {
            const syncStatus = document.getElementById('sync-status');
            const adminSyncStatus = document.getElementById('admin-sync-status');
            
            if (syncStatus) {
                syncStatus.innerHTML = `<i class="fas fa-${isSuccess ? 'check-circle' : 'exclamation-circle'}"></i> <span>${message}</span>`;
                syncStatus.className = `sync-status ${isSuccess ? 'synced' : 'error'}`;
            }
            
            if (adminSyncStatus) {
                adminSyncStatus.innerHTML = `<i class="fas fa-${isSuccess ? 'check-circle' : 'exclamation-circle'}"></i> <span>${message}</span>`;
                adminSyncStatus.className = `sync-status ${isSuccess ? 'synced' : 'error'}`;
            }
        }
        
        // ========== ОСНОВНЫЕ ФУНКЦИИ ==========
        
        function checkAdminStatus() {
            const currentUser = db.getCurrentUser();
            appState.isAdmin = (currentUser.id === ADMIN_TELEGRAM_ID.toString());
            
            const adminBtn = document.getElementById('admin-btn');
            if (adminBtn) {
                adminBtn.style.display = appState.isAdmin ? 'block' : 'none';
            }
        }
        
        function showPage(pageId) {
            // Скрываем все страницы
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Показываем выбранную страницу
            document.getElementById(pageId).classList.add('active');
            
            // Обновляем навигацию
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            const navBtn = document.querySelector(`.nav-btn[onclick*="${pageId}"]`);
            if (navBtn) {
                navBtn.classList.add('active');
            } else {
                document.querySelector('.nav-btn[onclick*="home"]').classList.add('active');
            }
            
            // Выполняем действия для конкретной страницы
            switch(pageId) {
                case 'history':
                    loadTransactions();
                    break;
                case 'mailing':
                    updateSMSCost();
                    updateSubmitButton();
                    break;
                case 'deposit':
                    const hashInputSection = document.getElementById('hash-input-section');
                    const txHash = document.getElementById('tx-hash');
                    if (hashInputSection) hashInputSection.classList.remove('active');
                    if (txHash) txHash.value = '';
                    break;
                case 'admin-panel':
                    if (appState.isAdmin) {
                        loadAdminPanel();
                    } else {
                        showPage('home');
                    }
                    break;
            }
        }
        
        function loadUserData() {
            const user = db.getCurrentUser();
            const balance = db.getUserBalance(user.id);
            
            const balanceUsdt = document.getElementById('balance-usdt');
            const balanceTon = document.getElementById('balance-ton');
            
            if (balanceUsdt) balanceUsdt.textContent = balance.usdt.toFixed(2);
            if (balanceTon) balanceTon.textContent = balance.ton.toFixed(2);
            
            updateStatistics();
            updateMailingButton();
        }
        
        function updateStatistics() {
            const stats = db.getStats();
            const allRequests = db.getAllMailingRequests();
            const pendingRequests = allRequests.filter(r => r.status === 'pending').length;
            
            document.getElementById('total-sms').textContent = stats.totalSMS || 0;
            document.getElementById('total-cost').textContent = (stats.totalCost || 0).toFixed(2);
            
            const successRate = (stats.totalSMS > 0 && stats.successful > 0) ? 
                Math.round((stats.successful / stats.totalSMS) * 100) : 0;
            document.getElementById('success-rate').textContent = successRate + '%';
            
            document.getElementById('pending').textContent = pendingRequests;
        }
        
        function updateMailingButton() {
            const user = db.getCurrentUser();
            const balance = db.getUserBalance(user.id);
            const hasBalance = balance.usdt > 0 || balance.ton > 0;
            
            const mailingBtn = document.getElementById('mailing-btn');
            if (mailingBtn) {
                if (!hasBalance) {
                    mailingBtn.disabled = true;
                    mailingBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Пополните баланс';
                } else {
                    mailingBtn.disabled = false;
                    mailingBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Запустить рассылку';
                }
            }
        }
        
        function updateSubmitButton() {
            const user = db.getCurrentUser();
            const balance = db.getUserBalance(user.id);
            
            const numbersText = document.getElementById('phone-numbers')?.value || '';
            const text = document.getElementById('sms-text')?.value || '';
            
            const numbers = numbersText.split(';')
                .map(n => n.trim())
                .filter(n => n.length > 5);
            
            const count = numbers.length;
            const costUSDT = count * 1;
            const costTON = count * 0.65;
            
            const hasEnoughBalance = balance.usdt >= costUSDT || balance.ton >= costTON;
            const hasNumbers = count > 0;
            const hasText = text.trim().length > 0;
            
            const submitMailingBtn = document.getElementById('submit-mailing-btn');
            if (submitMailingBtn) {
                if (!hasNumbers || !hasText || !hasEnoughBalance) {
                    submitMailingBtn.disabled = true;
                    submitMailingBtn.innerHTML = '<i class="fas fa-exclamation-circle"></i> Проверьте данные';
                } else {
                    submitMailingBtn.disabled = false;
                    submitMailingBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Отправить на модерацию';
                }
            }
        }
        
        function selectCurrency(currency) {
            appState.selectedCurrency = currency;
            
            document.querySelectorAll('.deposit-option').forEach(option => {
                option.classList.remove('active');
            });
            
            if (currency === 'USDT') {
                document.querySelectorAll('.deposit-option')[0].classList.add('active');
                document.getElementById('deposit-info').innerHTML = `
                    <p><strong>USDT (TRON TRC20)</strong><br>
                    Отправьте точную сумму на указанный адрес.<br>
                    Комиссию оплачивает отправитель.</p>
                `;
                document.getElementById('selected-currency').textContent = 'USDT';
                document.getElementById('min-currency').textContent = 'USDT';
                document.getElementById('deposit-address').textContent = 'TJSgjT9n1234567890abcdefghijklmnop';
            } else {
                document.querySelectorAll('.deposit-option')[1].classList.add('active');
                document.getElementById('deposit-info').innerHTML = `
                    <p><strong>TON (The Open Network)</strong><br>
                    Отправьте точную сумму на указанный адрес.<br>
                    Комиссию оплачивает отправитель.</p>
                `;
                document.getElementById('selected-currency').textContent = 'TON';
                document.getElementById('min-currency').textContent = 'TON';
                document.getElementById('deposit-address').textContent = 'EQCD39VS5jcptHL8vMjEXrzGaRcCVYto7HUn4bpAOg8xqB2N';
            }
        }
        
        function selectAmount(amount) {
            appState.selectedAmount = amount;
            
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseFloat(btn.textContent) === amount || 
                    (btn.textContent === 'Другая' && amount === 'custom')) {
                    btn.classList.add('active');
                }
            });
            
            const customAmountSection = document.getElementById('custom-amount-section');
            const customAmountInput = document.getElementById('custom-amount-input');
            
            if (amount !== 'custom') {
                if (customAmountSection) customAmountSection.style.display = 'none';
                if (customAmountInput) customAmountInput.value = amount;
            } else {
                if (customAmountSection) customAmountSection.style.display = 'block';
                if (customAmountInput) customAmountInput.focus();
            }
        }
        
        function selectCustomAmount() {
            selectAmount('custom');
        }
        
        function updateSMSCost() {
            const numbersText = document.getElementById('phone-numbers')?.value || '';
            const numbers = numbersText.split(';')
                .map(n => n.trim())
                .filter(n => n.length > 5);
            
            const count = numbers.length;
            const costUSDT = count * 1;
            const costTON = count * 0.65;
            
            const smsCost = document.getElementById('sms-cost');
            const smsCostTon = document.getElementById('sms-cost-ton');
            
            if (smsCost) smsCost.textContent = costUSDT.toFixed(2);
            if (smsCostTon) smsCostTon.textContent = costTON.toFixed(2);
            
            updateSubmitButton();
        }
        
        function copyAddress() {
            const address = document.getElementById('deposit-address').textContent;
            navigator.clipboard.writeText(address)
                .then(() => {
                    tg.showAlert('Адрес скопирован в буфер обмена!');
                })
                .catch(err => {
                    tg.showAlert('Ошибка копирования: ' + err);
                });
        }
        
        function showHashInput() {
            const hashInputSection = document.getElementById('hash-input-section');
            const txHash = document.getElementById('tx-hash');
            
            if (hashInputSection) hashInputSection.classList.add('active');
            if (txHash) txHash.focus();
            
            tg.showAlert('Пожалуйста, введите HASH транзакции после оплаты');
        }
        
        async function submitPayment() {
            const hash = document.getElementById('tx-hash')?.value.trim() || '';
            const amount = appState.selectedAmount;
            const currency = appState.selectedCurrency;
            
            if (!hash) {
                tg.showAlert('Введите HASH транзакции!');
                return;
            }
            
            const user = db.getCurrentUser();
            
            const paymentRequest = {
                id: Date.now(),
                userId: user.id,
                username: user.username,
                firstName: user.firstName,
                hash: hash,
                amount: amount,
                currency: currency,
                date: new Date().toLocaleString('ru-RU'),
                status: 'pending',
                userInfo: user
            };
            
            db.addPayment(paymentRequest);
            
            tg.showAlert(`Платеж отправлен на проверку!\nСумма: ${amount} ${currency}\nХеш: ${hash}`);
            
            document.getElementById('tx-hash').value = '';
            document.getElementById('hash-input-section').classList.remove('active');
            
            showPage('home');
        }
        
        async function submitMailing() {
            const numbers = document.getElementById('phone-numbers')?.value.trim() || '';
            const text = document.getElementById('sms-text')?.value.trim() || '';
            
            if (!numbers) {
                tg.showAlert('Введите номера телефонов!');
                return;
            }
            
            if (!text) {
                tg.showAlert('Введите текст СМС!');
                return;
            }
            
            const numbersArray = numbers.split(';')
                .map(n => n.trim())
                .filter(n => n.length > 5);
            
            const count = numbersArray.length;
            const costUSDT = count * 1;
            const costTON = count * 0.65;
            
            const user = db.getCurrentUser();
            const balance = db.getUserBalance(user.id);
            
            if (balance.usdt < costUSDT && balance.ton < costTON) {
                tg.showAlert(`Недостаточно средств!\nТребуется: ${costUSDT} USDT или ${costTON.toFixed(2)} TON`);
                return;
            }
            
            const requestId = Date.now();
            
            const mailingRequest = {
                id: requestId,
                userId: user.id,
                username: user.username,
                firstName: user.firstName,
                numbers: numbersArray,
                text: text,
                count: count,
                costUSDT: costUSDT,
                costTON: costTON,
                date: new Date().toLocaleString('ru-RU'),
                status: 'pending',
                userInfo: user
            };
            
            db.addMailingRequest(mailingRequest);
            
            const stats = db.getStats();
            stats.pending = (stats.pending || 0) + 1;
            db.updateStats(stats);
            
            tg.showAlert(`Заявка отправлена на модерацию!\nНомеров: ${count}\nСтоимость: ${costUSDT} USDT`);
            
            document.getElementById('phone-numbers').value = '';
            document.getElementById('sms-text').value = '';
            document.getElementById('char-count').textContent = '0';
            
            showPage('home');
            updateStatistics();
        }
        
        function loadTransactions() {
            const user = db.getCurrentUser();
            const allRequests = db.getAllMailingRequests();
            const allPayments = db.getAllPayments();
            
            let userTransactions = [];
            
            // Заявки на рассылку пользователя
            allRequests.filter(r => r.userId === user.id).forEach(request => {
                userTransactions.push({
                    type: request.status === 'approved' ? 'mailing_sent' : 'mailing_rejected',
                    amount: request.costUSDT,
                    currency: 'USDT',
                    date: request.date,
                    message: request.status === 'approved' ? 
                        `Рассылка на ${request.count} номеров` : 
                        `Рассылка отклонена`,
                    status: request.status
                });
            });
            
            // Платежи пользователя
            allPayments.filter(p => p.userId === user.id).forEach(payment => {
                userTransactions.push({
                    type: 'deposit',
                    amount: payment.amount,
                    currency: payment.currency,
                    date: payment.date,
                    message: payment.status === 'confirmed' ? 'Пополнение баланса' : 
                            payment.status === 'pending' ? 'Пополнение в обработке' : 'Пополнение отменено',
                    status: payment.status
                });
            });
            
            // Сортировка по дате (новые сначала)
            userTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let html = '';
            
            if (userTransactions.length === 0) {
                html = '<div class="loading"><p>Нет транзакций</p></div>';
            } else {
                userTransactions.forEach(transaction => {
                    const isDeposit = transaction.type === 'deposit';
                    const isPending = transaction.status === 'pending';
                    
                    let icon = 'fa-paper-plane';
                    let colorClass = 'payment';
                    let sign = '-';
                    let title = 'Рассылка';
                    
                    if (isDeposit) {
                        icon = 'fa-arrow-down';
                        colorClass = 'deposit';
                        sign = '+';
                        title = 'Пополнение';
                        if (isPending) {
                            icon = 'fa-clock';
                            colorClass = 'payment';
                        }
                    } else if (transaction.type === 'mailing_rejected') {
                        icon = 'fa-times';
                        colorClass = 'payment';
                        sign = '';
                        title = 'Рассылка отклонена';
                    }
                    
                    let statusText = '';
                    if (isPending) {
                        statusText = '<span style="font-size: 10px; color: #ff9900;">(ожидание)</span>';
                    } else if (transaction.status === 'rejected' || transaction.status === 'cancelled') {
                        statusText = '<span style="font-size: 10px; color: #ff4444;">(отменено)</span>';
                    }
                    
                    html += `
                        <div class="history-item">
                            <div class="history-type">
                                <div class="history-icon ${colorClass}">
                                    <i class="fas ${icon}"></i>
                                </div>
                                <div class="history-details">
                                    <h4>${title} ${statusText}</h4>
                                    <p>${transaction.date}</p>
                                    <p style="font-size: 12px; color: #888;">${transaction.message}</p>
                                </div>
                            </div>
                            ${transaction.amount ? `
                                <div class="history-amount">
                                    <div class="amount" style="color: ${isDeposit ? '#00c851' : '#ff4444'}">
                                        ${sign}${transaction.amount}
                                    </div>
                                    <div class="currency">${transaction.currency}</div>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
            }
            
            document.getElementById('transactions-list').innerHTML = html;
        }
        
        // ========== АДМИН ФУНКЦИ// ========== АДМИН ФУНКЦИИ ==========
        
        function checkAdminAccess() {
            if (appState.isAdmin) {
                showPage('admin-panel');
            } else {
                tg.showAlert('Доступ запрещен! Только для администратора.');
            }
        }
        
        function loadAdminPanel() {
            updateAdminCounters();
            showAdminSection('all-users');
        }
        
        function updateAdminCounters() {
            const allUsers = Object.keys(db.getAllUsers()).length;
            const allRequests = db.getAllMailingRequests().length;
            const allPayments = db.getAllPayments().length;
            
            document.getElementById('users-count').textContent = allUsers;
            document.getElementById('mailings-count').textContent = allRequests;
            document.getElementById('payments-count').textContent = allPayments;
            document.getElementById('transactions-count').textContent = allRequests + allPayments;
        }
        
        function showAdminSection(section) {
            let content = '';
            
            switch(section) {
                case 'all-users':
                    content = loadAllUsers();
                    break;
                    
                case 'all-transactions':
                    content = loadAllTransactions();
                    break;
                    
                case 'all-mailings':
                    content = loadAllMailings();
                    break;
                    
                case 'payment-requests':
                    content = loadPaymentRequests();
                    break;
                    
                case 'stats':
                    content = loadAdminStats();
                    break;
            }
            
            document.getElementById('admin-content').innerHTML = content;
            updateAdminCounters();
        }
        
        function loadAllUsers() {
            const users = db.getAllUsers();
            const allRequests = db.getAllMailingRequests();
            const allPayments = db.getAllPayments();
            
            let usersList = [];
            
            // Преобразуем объект пользователей в массив
            Object.values(users).forEach(user => {
                const userRequests = allRequests.filter(r => r.userId === user.id);
                const userPayments = allPayments.filter(p => p.userId === user.id);
                
                usersList.push({
                    ...user,
                    mailingsCount: userRequests.filter(r => r.status === 'approved').length,
                    pendingMailings: userRequests.filter(r => r.status === 'pending').length,
                    totalSMS: userRequests.filter(r => r.status === 'approved')
                        .reduce((sum, r) => sum + (r.count || 0), 0),
                    deposits: userPayments.filter(p => p.status === 'confirmed')
                        .reduce((sum, p) => sum + (p.amount || 0), 0),
                    pendingPayments: userPayments.filter(p => p.status === 'pending').length
                });
            });
            
            // Сортировка по дате регистрации (новые сначала)
            usersList.sort((a, b) => new Date(b.registrationDate) - new Date(a.registrationDate));
            
            let usersHtml = `
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-users"></i>
                        Все пользователи (${usersList.length})
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterUsers('all')">Все</button>
                        <button class="filter-btn" onclick="filterUsers('with_balance')">С балансом</button>
                        <button class="filter-btn" onclick="filterUsers('with_mailings')">С рассылками</button>
                        <button class="filter-btn" onclick="filterUsers('recent')">Недавние</button>
                    </div>
                    <div class="user-list" id="users-list-container">
            `;
            
            if (usersList.length === 0) {
                usersHtml += '<p style="text-align: center; color: #666; padding: 20px;">Нет пользователей</p>';
            } else {
                usersList.forEach(user => {
                    const lastActive = user.lastActive ? new Date(user.lastActive).toLocaleString('ru-RU') : 'Неизвестно';
                    
                    usersHtml += `
                        <div class="user-item" data-userid="${user.id}" data-balance="${user.balance.usdt}" data-mailings="${user.mailingsCount}">
                            <div class="user-info">
                                <h4>${user.firstName} ${user.lastName || ''}</h4>
                                <p><strong>ID:</strong> ${user.id}</p>
                                <p><strong>Username:</strong> @${user.username}</p>
                                <p><strong>Язык:</strong> ${user.languageCode || 'ru'}</p>
                                <p><strong>Регистрация:</strong> ${user.registrationDate}</p>
                                <p><strong>Активен:</strong> ${lastActive}</p>
                                <p style="font-size: 12px; color: #888; margin-top: 5px;">
                                    <strong>Статистика:</strong><br>
                                    • Баланс: $${user.balance.usdt.toFixed(2)} USDT, ${user.balance.ton.toFixed(2)} TON<br>
                                    • Пополнений: $${user.deposits.toFixed(2)} (${user.pendingPayments} в ожидании)<br>
                                    • Рассылок: ${user.mailingsCount} (${user.totalSMS} SMS, ${user.pendingMailings} в ожидании)
                                </p>
                            </div>
                            <div class="user-balance">
                                <div class="amount" style="color: #8e44ad; font-size: 14px;">${user.id}</div>
                                <div class="currency">Telegram ID</div>
                                <div style="margin-top: 10px;">
                                    <button onclick="editUserBalance('${user.id}')" style="padding: 5px 10px; background: #0088cc; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                        <i class="fas fa-edit"></i> Изменить баланс
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            usersHtml += `
                    </div>
                </div>
            `;
            
            return usersHtml;
        }
        
        function filterUsers(filter) {
            const items = document.querySelectorAll('#users-list-container .user-item');
            items.forEach(item => {
                const balance = parseFloat(item.getAttribute('data-balance'));
                const mailings = parseInt(item.getAttribute('data-mailings'));
                
                let show = true;
                
                switch(filter) {
                    case 'with_balance':
                        show = balance > 0;
                        break;
                    case 'with_mailings':
                        show = mailings > 0;
                        break;
                    case 'recent':
                        // Показываем только пользователей, зарегистрированных за последние 7 дней
                        const registrationDate = item.querySelector('.user-info p:nth-child(5)').textContent;
                        const regDate = new Date(registrationDate.split(': ')[1]);
                        const weekAgo = new Date();
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        show = regDate >= weekAgo;
                        break;
                }
                
                item.style.display = show ? 'flex' : 'none';
            });
            
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function editUserBalance(userId) {
            const users = db.getAllUsers();
            const user = users[userId];
            
            if (!user) {
                tg.showAlert('Пользователь не найден!');
                return;
            }
            
            const newUsdt = prompt(`Введите новый баланс USDT для пользователя ${user.firstName} (@${user.username}):`, user.balance.usdt);
            if (newUsdt === null) return;
            
            const newTon = prompt(`Введите новый баланс TON для пользователя ${user.firstName} (@${user.username}):`, user.balance.ton);
            if (newTon === null) return;
            
            const usdtValue = parseFloat(newUsdt);
            const tonValue = parseFloat(newTon);
            
            if (isNaN(usdtValue) || isNaN(tonValue)) {
                tg.showAlert('Некорректные значения!');
                return;
            }
            
            user.balance.usdt = usdtValue;
            user.balance.ton = tonValue;
            user.lastActive = new Date().toISOString();
            
            db.saveToLocalStorage();
            db.syncToCloud();
            
            tg.showAlert(`Баланс пользователя обновлен!\nUSDT: ${usdtValue}\nTON: ${tonValue}`);
            
            showAdminSection('all-users');
        }
        
        function loadAllTransactions() {
            const allPayments = db.getAllPayments();
            const allRequests = db.getAllMailingRequests();
            
            let allTransactions = [];
            
            // Добавляем платежи
            allPayments.forEach(payment => {
                allTransactions.push({
                    type: 'payment',
                    id: payment.id,
                    userId: payment.userId,
                    username: payment.username,
                    firstName: payment.firstName,
                    amount: payment.amount,
                    currency: payment.currency,
                    date: payment.date,
                    status: payment.status,
                    hash: payment.hash,
                    userInfo: payment.userInfo
                });
            });
            
            // Добавляем рассылки
            allRequests.forEach(request => {
                allTransactions.push({
                    type: 'mailing',
                    id: request.id,
                    userId: request.userId,
                    username: request.username,
                    firstName: request.firstName,
                    amount: request.costUSDT,
                    currency: 'USDT',
                    date: request.date,
                    status: request.status,
                    count: request.count,
                    userInfo: request.userInfo
                });
            });
            
            // Сортировка по дате (новые сначала)
            allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            let transactionsHtml = `
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-exchange-alt"></i>
                        Все транзакции (${allTransactions.length})
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterTransactions('all')">Все</button>
                        <button class="filter-btn" onclick="filterTransactions('payments')">Пополнения</button>
                        <button class="filter-btn" onclick="filterTransactions('mailings')">Рассылки</button>
                        <button class="filter-btn" onclick="filterTransactions('pending')">В ожидании</button>
                        <button class="filter-btn" onclick="filterTransactions('completed')">Завершенные</button>
                    </div>
                    <div id="transactions-list-container">
            `;
            
            if (allTransactions.length === 0) {
                transactionsHtml += '<p style="text-align: center; color: #666; padding: 20px;">Нет транзакций</p>';
            } else {
                allTransactions.forEach(transaction => {
                    const isPayment = transaction.type === 'payment';
                    const isDeposit = isPayment && transaction.status === 'confirmed';
                    const isPending = transaction.status === 'pending';
                    
                    let statusBadge = '';
                    if (transaction.status === 'pending') {
                        statusBadge = '<span class="status-badge status-pending">В ожидании</span>';
                    } else if (transaction.status === 'confirmed' || transaction.status === 'approved') {
                        statusBadge = '<span class="status-badge status-confirmed">Подтверждено</span>';
                    } else if (transaction.status === 'cancelled' || transaction.status === 'rejected') {
                        statusBadge = '<span class="status-badge status-cancelled">Отменено</span>';
                    }
                    
                    let detailsHtml = '';
                    if (isPayment) {
                        detailsHtml = `
                            <p><strong>Хеш транзакции:</strong> ${transaction.hash || 'Нет'}</p>
                            <p><strong>Статус:</strong> ${transaction.status}</p>
                        `;
                    } else {
                        detailsHtml = `
                            <p><strong>Количество SMS:</strong> ${transaction.count}</p>
                            <p><strong>Статус:</strong> ${transaction.status}</p>
                        `;
                    }
                    
                    transactionsHtml += `
                        <div class="transaction-item" data-type="${transaction.type}" data-status="${transaction.status}">
                            <div class="transaction-type">
                                <div class="transaction-icon ${isDeposit ? 'deposit' : 'payment'}">
                                    <i class="fas ${isPayment ? 'fa-money-bill-wave' : 'fa-paper-plane'}"></i>
                                </div>
                                <div class="transaction-details">
                                    <h4>${isPayment ? 'Пополнение' : 'Рассылка'} #${transaction.id} ${statusBadge}</h4>
                                    <p><strong>Пользователь:</strong> ${transaction.firstName} (@${transaction.username})</p>
                                    <p><strong>ID:</strong> ${transaction.userId}</p>
                                    ${detailsHtml}
                                    <p><strong>Дата:</strong> ${transaction.date}</p>
                                </div>
                            </div>
                            <div class="transaction-amount">
                                <div class="amount" style="color: ${isDeposit ? '#00c851' : '#ff4444'}">
                                    ${isDeposit ? '+' : '-'}${transaction.amount}
                                </div>
                                <div class="currency">${transaction.currency}</div>
                                ${isPending ? `
                                    <div style="margin-top: 5px;">
                                        ${isPayment ? `
                                            <button onclick="confirmPaymentAdmin(${transaction.id})" style="padding: 5px 10px; background: #00c851; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; margin-right: 5px;">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button onclick="cancelPaymentAdmin(${transaction.id})" style="padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        ` : `
                                            <button onclick="approveRequest(${transaction.id})" style="padding: 5px 10px; background: #00c851; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px; margin-right: 5px;">
                                                <i class="fas fa-check"></i>
                                            </button>
                                            <button onclick="rejectRequest(${transaction.id})" style="padding: 5px 10px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        `}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    `;
                });
            }
            
            transactionsHtml += `
                    </div>
                </div>
            `;
            
            return transactionsHtml;
        }
        
        function filterTransactions(filter) {
            const items = document.querySelectorAll('#transactions-list-container .transaction-item');
            items.forEach(item => {
                const type = item.getAttribute('data-type');
                const status = item.getAttribute('data-status');
                
                let show = true;
                
                switch(filter) {
                    case 'payments':
                        show = type === 'payment';
                        break;
                    case 'mailings':
                        show = type === 'mailing';
                        break;
                    case 'pending':
                        show = status === 'pending';
                        break;
                    case 'completed':
                        show = status === 'confirmed' || status === 'approved';
                        break;
                }
                
                item.style.display = show ? 'flex' : 'none';
            });
            
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function loadAllMailings() {
            const allRequests = db.getAllMailingRequests();
            
            let mailingsHtml = `
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-envelope"></i>
                        Все рассылки (${allRequests.length})
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterMailings('all')">Все</button>
                        <button class="filter-btn" onclick="filterMailings('pending')">В ожидании</button>
                        <button class="filter-btn" onclick="filterMailings('approved')">Подтвержденные</button>
                        <button class="filter-btn" onclick="filterMailings('rejected')">Отклоненные</button>
                    </div>
                    <div id="mailings-list-container">
            `;
            
            if (allRequests.length === 0) {
                mailingsHtml += '<p style="text-align: center; color: #666; padding: 20px;">Нет рассылок</p>';
            } else {
                // Сортировка по дате (новые сначала)
                const sortedRequests = [...allRequests].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedRequests.forEach(request => {
                    const numbersDisplay = request.numbers.slice(0, 3).join(', ') + (request.numbers.length > 3 ? '...' : '');
                    
                    let statusBadge = '';
                    if (request.status === 'pending') {
                        statusBadge = '<span class="status-badge status-pending">В ожидании</span>';
                    } else if (request.status === 'approved') {
                        statusBadge = '<span class="status-badge status-approved">Подтверждена</span>';
                    } else if (request.status === 'rejected') {
                        statusBadge = '<span class="status-badge status-rejected">Отклонена</span>';
                    }
                    
                    let actionsHTML = '';
                    if (request.status === 'pending') {
                        actionsHTML = `
                            <div class="request-actions">
                                <button class="btn btn-success" onclick="approveRequest(${request.id})">
                                    <i class="fas fa-check"></i>
                                    Подтвердить
                                </button>
                                <button class="btn btn-danger" onclick="rejectRequest(${request.id})">
                                    <i class="fas fa-times"></i>
                                    Отклонить
                                </button>
                            </div>
                        `;
                    }
                    
                    mailingsHtml += `
                        <div class="request-item" data-status="${request.status}">
                            <div class="request-header">
                                <div>
                                    <div class="request-id">Заявка #${request.id} ${statusBadge}</div>
                                    <div class="request-user"><strong>Пользователь:</strong> ${request.firstName} (@${request.username})</div>
                                    <div class="request-user"><strong>ID:</strong> ${request.userId}</div>
                                    <div class="request-date">${request.date}</div>
                                </div>
                            </div>
                            
                            <div class="request-numbers">
                                <h4>Номера телефонов (${request.count} шт.):</h4>
                                <div class="numbers-list">${numbersDisplay}</div>
                            </div>
                            
                            <div class="request-text">
                                <h4>Текст сообщения:</h4>
                                <div class="text-content">${request.text}</div>
                            </div>
                            
                            <div class="request-cost">
                                <div class="cost-item">
                                    <div class="cost-label">USDT</div>
                                    <div class="cost-value">${request.costUSDT}</div>
                                </div>
                                <div class="cost-item">
                                    <div class="cost-label">TON</div>
                                    <div class="cost-value">${request.costTON.toFixed(2)}</div>
                                </div>
                                <div class="cost-item">
                                    <div class="cost-label">SMS</div>
                                    <div class="cost-value">${request.count}</div>
                                </div>
                            </div>
                            
                            ${actionsHTML}
                        </div>
                    `;
                });
            }
            
            mailingsHtml += `
                    </div>
                </div>
            `;
            
            return mailingsHtml;
        }
        
        function filterMailings(filter) {
            const items = document.querySelectorAll('#mailings-list-container .request-item');
            items.forEach(item => {
                const status = item.getAttribute('data-status');
                
                let show = true;
                if (filter === 'pending' && status !== 'pending') show = false;
                if (filter === 'approved' && status !== 'approved') show = false;
                if (filter === 'rejected' && status !== 'rejected') show = false;
                
                item.style.display = show ? 'block' : 'none';
            });
            
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function loadPaymentRequests() {
            const allPayments = db.getAllPayments();
            
            let paymentsHtml = `
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-money-check-alt"></i>
                        Запросы на пополнение (${allPayments.length})
                    </div>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterPayments('all')">Все</button>
                        <button class="filter-btn" onclick="filterPayments('pending')">В ожидании</button>
                        <button class="filter-btn" onclick="filterPayments('confirmed')">Подтвержденные</button>
                        <button class="filter-btn" onclick="filterPayments('cancelled')">Отмененные</button>
                    </div>
                    <div id="payments-list-container">
            `;
            
            if (allPayments.length === 0) {
                paymentsHtml += '<p style="text-align: center; color: #666; padding: 20px;">Нет запросов на пополнение</p>';
            } else {
                // Сортировка по дате (новые сначала)
                const sortedPayments = [...allPayments].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                sortedPayments.forEach(payment => {
                    let statusBadge = '';
                    if (payment.status === 'pending') {
                        statusBadge = '<span class="status-badge status-pending">В ожидании</span>';
                    } else if (payment.status === 'confirmed') {
                        statusBadge = '<span class="status-badge status-confirmed">Подтвержден</span>';
                    } else if (payment.status === 'cancelled') {
                        statusBadge = '<span class="status-badge status-cancelled">Отменен</span>';
                    }
                    
                    let actionsHTML = '';
                    if (payment.status === 'pending') {
                        actionsHTML = `
                            <div style="display: flex; gap: 10px; margin-top: 10px;">
                                <button onclick="confirmPaymentAdmin(${payment.id})" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #00c851, #5eff8f); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-check"></i> Подтвердить
                                </button>
                                <button onclick="cancelPaymentAdmin(${payment.id})" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #ff4444, #ff8888); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                    <i class="fas fa-times"></i> Отменить
                                </button>
                            </div>
                        `;
                    }
                    
                    paymentsHtml += `
                        <div class="request-item" data-status="${payment.status}">
                            <div class="request-header">
                                <div>
                                    <div class="request-id">Запрос #${payment.id} ${statusBadge}</div>
                                    <div class="request-user"><strong>Пользователь:</strong> ${payment.firstName} (@${payment.username})</div>
                                    <div class="request-user"><strong>ID:</strong> ${payment.userId}</div>
                                    <div class="request-date">${payment.date}</div>
                                </div>
                            </div>
                            
                            <div style="margin: 15px 0;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Сумма:</div>
                                <div style="font-size: 24px; font-weight: 700; color: #0088cc;">
                                    ${payment.amount} ${payment.currency}
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 15px;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 5px;">Хеш транзакции:</div>
                                <div style="background: #f8fdff; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 12px; word-break: break-all;">
                                    ${payment.hash}
                                </div>
                            </div>
                            
                            ${actionsHTML}
                        </div>
                    `;
                });
            }
            
            paymentsHtml += `
                    </div>
                </div>
            `;
            
            return paymentsHtml;
        }
        
        function filterPayments(filter) {
            const items = document.querySelectorAll('#payments-list-container .request-item');
            items.forEach(item => {
                const status = item.getAttribute('data-status');
                
                let show = true;
                if (filter === 'pending' && status !== 'pending') show = false;
                if (filter === 'confirmed' && status !== 'confirmed') show = false;
                if (filter === 'cancelled' && status !== 'cancelled') show = false;
                
                item.style.display = show ? 'block' : 'none';
            });
            
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }
        
        function loadAdminStats() {
            const stats = db.getStats();
            const users = db.getAllUsers();
            const allRequests = db.getAllMailingRequests();
            const allPayments = db.getAllPayments();
            
            const totalUsers = Object.keys(users).length;
            const pendingPayments = allPayments.filter(p => p.status === 'pending').length;
            const confirmedPayments = allPayments.filter(p => p.status === 'confirmed').length;
            const totalDeposits = allPayments.filter(p => p.status === 'confirmed')
                .reduce((sum, p) => sum + p.amount, 0);
            
            const pendingMailings = allRequests.filter(r => r.status === 'pending').length;
            const approvedMailings = allRequests.filter(r => r.status === 'approved').length;
            const rejectedMailings = allRequests.filter(r => r.status === 'rejected').length;
            
            // Рассчитываем средний баланс пользователей
            let totalUsdt = 0;
            let totalTon = 0;
            Object.values(users).forEach(user => {
                totalUsdt += user.balance.usdt;
                totalTon += user.balance.ton;
            });
            const avgUsdt = totalUsers > 0 ? totalUsdt / totalUsers : 0;
            const avgTon = totalUsers > 0 ? totalTon / totalUsers : 0;
            
            // Находим самых активных пользователей
            const topUsers = Object.values(users)
                .sort((a, b) => (b.deposits || 0) - (a.deposits || 0))
                .slice(0, 5);
            
            let topUsersHtml = '';
            topUsers.forEach((user, index) => {
                topUsersHtml += `
                    <div style="padding: 8px; border-bottom: 1px solid #eee; font-size: 12px;">
                        ${index + 1}. ${user.firstName} (@${user.username}) - $${user.deposits?.toFixed(2) || '0.00'}
                    </div>
                `;
            });
            
            return `
                <div class="card">
                    <div class="card-title">
                        <i class="fas fa-chart-bar"></i>
                        Статистика системы
                    </div>
                    <div class="admin-stats-grid">
                        <div class="admin-stat-item">
                            <div class="admin-stat-value">${totalUsers}</div>
                            <div class="admin-stat-label">Всего пользователей</div>
                        </div>
                        <div class="admin-stat-item">
                            <div class="admin-stat-value">${allRequests.length}</div>
                            <div class="admin-stat-label">Всего заявок</div>
                        </div>
                        <div class="admin-stat-item">
                            <div class="admin-stat-value">$${totalDeposits.toFixed(2)}</div>
                            <div class="admin-stat-label">Общая сумма пополнений</div>
                        </div>
                        <div class="admin-stat-item">
                            <div class="admin-stat-value">$${stats.totalRevenue?.toFixed(2) || '0.00'}</div>
                            <div class="admin-stat-label">Общая выручка</div>
                        </div>
                        <div class="admin-stat-item">
                            <div class="admin-stat-value">${pendingPayments}</div>
                            <div class="admin-stat-label">Запросов на пополнение</div>
                        </div>
                        <div class="admin-stat-item">
                            <div class="admin-stat-value">${confirmedPayments}</div>
                            <div class="admin-stat-label">Подтвержденных платежей</div>
                        </div>
                        <div class="admin-stat-item">
                            <div class="admin-stat-value">${pendingMailings}</div>
                            <div class="admin-stat-label">Рассылок в ожидании</div>
                        </div>
                        <div class="admin-stat-item">
                            <div class="admin-stat-value">${approvedMailings}</div>
                            <div class="admin-stat-label">Подтвержденных рассылок</div>
                        </div>
                        <div class="admin-stat-item">
                            <div class="admin-stat-value">${stats.totalSMS || 0}</div>
                            <div class="admin-stat-label">Всего SMS отправлено</div>
                        </div>
                        <div class="admin-stat-item">
                            <div class="admin-stat-value">${rejectedMailings}</div>
                            <div class="admin-stat-label">Отклоненных рассылок</div>
                        </div>
                        <div class="admin-stat-item">
                            <div class="admin-stat-value">$${avgUsdt.toFixed(2)}</div>
                            <div class="admin-stat-label">Средний баланс USDT</div>
                        </div>
                        <div class="admin-stat-item">
                            <div class="admin-stat-value">${avgTon.toFixed(2)}</div>
                            <div class="admin-stat-label">Средний баланс TON</div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px; background: #f9f0ff; padding: 15px; border-radius: 10px;">
                        <h4 style="color: #8e44ad; margin-bottom: 10px;">Топ-5 пользователей по пополнениям:</h4>
                        ${topUsersHtml || '<p style="text-align: center; color: #666;">Нет данных</p>'}
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <button class="btn btn-secondary" onclick="resetSystemStats()" style="margin-right: 10px;">
                            <i class="fas fa-redo"></i> Сбросить статистику
                        </button>
                        <button class="btn btn-danger" onclick="clearAllData()">
                            <i class="fas fa-trash"></i> Очистить все данные
                        </button>
                    </div>
                </div>
            `;
        }
        
        async function approveRequest(requestId) {
            const request = db.findMailingRequestById(requestId);
            
            if (!request) {
                tg.showAlert('Заявка не найдена!');
                return;
            }
            
            // Обновляем статус заявки
            db.updateMailingRequest(requestId, {
                status: 'approved',
                processedDate: new Date().toLocaleString('ru-RU'),
                processedBy: 'admin'
            });
            
            // Списываем средства с баланса пользователя
            db.updateUserBalance(request.userId, 'USDT', request.costUSDT, false);
            
            // Обновляем статистику
            const stats = db.getStats();
            stats.totalSMS = (stats.totalSMS || 0) + request.count;
            stats.totalCost = (stats.totalCost || 0) + request.costUSDT;
            stats.successful = (stats.successful || 0) + request.count;
            stats.pending = db.getAllMailingRequests().filter(r => r.status === 'pending').length;
            stats.totalRevenue = (stats.totalRevenue || 0) + request.costUSDT;
            db.updateStats(stats);
            
            tg.showAlert(`Заявка #${requestId} подтверждена!`);
            
            // Обновляем отображение
            if (document.getElementById('admin-panel').classList.contains('active')) {
                showAdminSection('all-mailings');
            }
            updateStatistics();
        }
        
        async function rejectRequest(requestId) {
            const request = db.findMailingRequestById(requestId);
            
            if (!request) {
                tg.showAlert('Заявка не найдена!');
                return;
            }
            
            // Обновляем статус заявки
            db.updateMailingRequest(requestId, {
                status: 'rejected',
                processedDate: new Date().toLocaleString('ru-RU'),
                processedBy: 'admin'
            });
            
            // Обновляем статистику
            const stats = db.getStats();
            stats.totalSMS = (stats.totalSMS || 0) + request.count;
            stats.rejected = (stats.rejected || 0) + request.count;
            stats.pending = db.getAllMailingRequests().filter(r => r.status === 'pending').length;
            db.updateStats(stats);
            
            tg.showAlert(`Заявка #${requestId} отклонена!`);
            
            // Обновляем отображение
            if (document.getElementById('admin-panel').classList.contains('active')) {
                showAdminSection('all-mailings');
            }
            updateStatistics();
        }
        
        async function confirmPaymentAdmin(paymentId) {
            const payment = db.findPaymentById(paymentId);
            
            if (!payment) {
                tg.showAlert('Платеж не найден!');
                return;
            }
            
            // Обновляем статус платежа
            db.updatePayment(paymentId, {
                status: 'confirmed',
                processedDate: new Date().toLocaleString('ru-RU'),
                processedBy: 'admin'
            });
            
            // Пополняем баланс пользователя
            db.updateUserBalance(payment.userId, payment.currency, payment.amount, true);
            
            tg.showAlert(`Платеж #${paymentId} подтвержден!`);
            
            // Обновляем отображение
            if (document.getElementById('admin-panel').classList.contains('active')) {
                showAdminSection('payment-requests');
            }
        }
        
        async function cancelPaymentAdmin(paymentId) {
            const payment = db.findPaymentById(paymentId);
            
            if (!payment) {
                tg.showAlert('Платеж не найден!');
                return;
            }
            
            // Обновляем статус платежа
            db.updatePayment(paymentId, {
                status: 'cancelled',
                processedDate: new Date().toLocaleString('ru-RU'),
                processedBy: 'admin'
            });
            
            tg.showAlert(`Платеж #${paymentId} отменен!`);
            
            // Обновляем отображение
            if (document.getElementById('admin-panel').classList.contains('active')) {
                showAdminSection('payment-requests');
            }
        }
        
        async function syncAllData() {
            updateSyncStatus(false, 'Синхронизация...');
            
            try {
                await db.syncToCloud();
                tg.showAlert('Данные успешно синхронизированы!');
            } catch (error) {
                tg.console.error('Ошибка синхронизации:', error);
                tg.showAlert('Ошибка синхронизации данных');
            }
        }
        
        function downloadBackup() {
            const backupData = db.getBackupData();
            const dataStr = JSON.stringify(backupData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `sms-mailing-backup-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            tg.showAlert('Бэкап данных скачан!');
        }
        
        function resetSystemStats() {
            if (confirm('Вы уверены, что хотите сбросить статистику системы? Это действие нельзя отменить.')) {
                const stats = {
                    totalSMS: 0,
                    totalCost: 0,
                    successful: 0,
                    rejected: 0,
                    pending: db.getAllMailingRequests().filter(r => r.status === 'pending').length,
                    totalRevenue: 0,
                    lastUpdate: new Date().toISOString()
                };
                
                db.updateStats(stats);
                tg.showAlert('Статистика системы сброшена!');
                showAdminSection('stats');
                updateStatistics();
            }
        }
        
        function clearAllData() {
            if (confirm('ВНИМАНИЕ! Это удалит ВСЕ данные системы (пользователей, транзакции, статистику). Продолжить?')) {
                if (confirm('Это действие НЕОБРАТИМО. Вы точно уверены?')) {
                    db.resetData();
                    tg.showAlert('Все данные системы удалены!');
                    showPage('home');
                    loadUserData();
                }
            }
        }
        
        // ========== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ==========
        
        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                return date.toLocaleString('ru-RU');
            } catch {
                return dateString;
            }
        }
        
        function formatCurrency(amount, currency) {
            if (currency === 'USDT') {
                return `$${amount.toFixed(2)}`;
            } else if (currency === 'TON') {
                return `⏣${amount.toFixed(2)}`;
            }
            return `${amount} ${currency}`;
        }
        
        // Автоматическая синхронизация при загрузке страницы
        window.addEventListener('load', async () => {
            // Синхронизируем данные каждые 30 секунд
            setInterval(async () => {
                if (db.isReady) {
                    await db.syncToCloud();
                }
            }, 30000);
            
            // Синхронизируем при видимости страницы
            document.addEventListener('visibilitychange', async () => {
                if (!document.hidden && db.isReady) {
                    await db.syncFromCloud();
                    loadUserData();
                }
            });
        });
        
        // Экспортируем функции для глобального доступа
        window.syncAllData = syncAllData;
        window.downloadBackup = downloadBackup;
        window.resetSystemStats = resetSystemStats;
        window.clearAllData = clearAllData;
        window.approveRequest = approveRequest;
        window.rejectRequest = rejectRequest;
        window.confirmPaymentAdmin = confirmPaymentAdmin;
        window.cancelPaymentAdmin = cancelPaymentAdmin;
        window.filterUsers = filterUsers;
        window.filterTransactions = filterTransactions;
        window.filterMailings = filterMailings;
        window.filterPayments = filterPayments;
        window.editUserBalance = editUserBalance;
        window.showAdminSection = showAdminSection;
        window.showPage = showPage;
        
    </script>
</body>
</html>
