<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SMS Mailing - Мини-приложение</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #0088cc 0%, #34b7f1 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 80px;
        }

        .app-header {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0, 136, 204, 0.2);
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #0088cc, #34b7f1);
            border-radius: 20px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            color: white;
        }

        h1 {
            color: #0088cc;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 16px;
            line-height: 1.5;
            margin-bottom: 15px;
        }

        .prices {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .price-badge {
            background: #f0f9ff;
            padding: 8px 15px;
            border-radius: 10px;
            color: #0088cc;
            font-weight: 600;
            font-size: 14px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 15px rgba(0, 136, 204, 0.1);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-2px);
        }

        .card-title {
            color: #0088cc;
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title i {
            font-size: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #0088cc, #34b7f1);
            color: white;
            border: none;
            padding: 16px 25px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: linear-gradient(135deg, #0077b3, #2aa8e0);
            box-shadow: 0 5px 15px rgba(0, 136, 204, 0.3);
        }

        .btn-secondary {
            background: white;
            color: #0088cc;
            border: 2px solid #0088cc;
        }

        .btn-secondary:hover {
            background: #f0f9ff;
        }

        .btn-success {
            background: linear-gradient(135deg, #00c851, #5eff8f);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #00b347, #4cff7a);
        }

        .btn-admin {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
        }

        .btn-admin:hover {
            background: linear-gradient(135deg, #7d3c98, #8e44ad);
        }

        .balance-card {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .balance-item {
            background: linear-gradient(135deg, #f0f9ff, #e1f5fe);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            border: 2px solid #d1ecff;
        }

        .currency {
            font-size: 14px;
            color: #666;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .amount {
            font-size: 32px;
            font-weight: 700;
            color: #0088cc;
        }

        .currency-symbol {
            font-size: 20px;
            margin-right: 2px;
        }

        .section {
            margin-bottom: 25px;
        }

        .section-title {
            color: white;
            font-size: 20px;
            margin-bottom: 15px;
            padding-left: 10px;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #0088cc;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
        }

        .nav-bottom {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-around;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            box-shadow: 0 -5px 20px rgba(0, 0, 0, 0.1);
        }

        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            color: #666;
            background: none;
            border: none;
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
            flex: 1;
            max-width: 100px;
        }

        .nav-btn:hover {
            background: #f0f9ff;
            color: #0088cc;
        }

        .nav-btn.active {
            color: #0088cc;
            background: #f0f9ff;
        }

        .nav-btn i {
            font-size: 22px;
        }

        .nav-btn span {
            font-size: 12px;
            font-weight: 500;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        .history-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-type {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .history-icon.deposit {
            background: linear-gradient(135deg, #00c851, #5eff8f);
        }

        .history-icon.payment {
            background: linear-gradient(135deg, #ff4444, #ff8888);
        }

        .history-details h4 {
            color: #333;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .history-details p {
            color: #666;
            font-size: 14px;
        }

        .history-amount {
            text-align: right;
        }

        .history-amount .amount {
            font-size: 18px;
            font-weight: 600;
        }

        .history-amount .currency {
            font-size: 12px;
            color: #999;
        }

        .deposit-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .deposit-option {
            background: linear-gradient(135deg, #f8fdff, #e6f7ff);
            border: 2px solid #d1ecff;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .deposit-option:hover {
            background: linear-gradient(135deg, #e6f7ff, #d4f1ff);
            border-color: #0088cc;
            transform: translateY(-3px);
        }

        .deposit-option.active {
            background: linear-gradient(135deg, #0088cc, #34b7f1);
            border-color: #0088cc;
            color: white;
        }

        .deposit-option.active .currency {
            color: white;
        }

        .deposit-option i {
            font-size: 32px;
            margin-bottom: 10px;
            color: #0088cc;
        }

        .deposit-option.active i {
            color: white;
        }

        .deposit-option .currency {
            font-size: 18px;
            font-weight: 600;
            color: #0088cc;
            margin-bottom: 5px;
        }

        .deposit-option.active .currency {
            color: white;
        }

        .deposit-amounts {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .amount-btn {
            background: white;
            border: 2px solid #d1ecff;
            border-radius: 10px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: #0088cc;
        }

        .amount-btn:hover {
            background: #f0f9ff;
            border-color: #0088cc;
        }

        .amount-btn.active {
            background: #0088cc;
            color: white;
            border-color: #0088cc;
        }

        .custom-amount {
            margin-top: 20px;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            color: #0088cc;
            font-weight: 500;
        }

        input, textarea {
            width: 100%;
            padding: 15px;
            border: 2px solid #d1ecff;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #0088cc;
            box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.1);
        }

        .info-box {
            background: #f0f9ff;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #0088cc;
        }

        .info-box p {
            color: #333;
            font-size: 14px;
            line-height: 1.5;
        }

        .address-box {
            background: #f8fdff;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border: 2px dashed #0088cc;
            word-break: break-all;
            font-family: monospace;
            font-size: 14px;
            color: #333;
            text-align: center;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #0088cc;
        }

        .loading i {
            font-size: 40px;
            margin-bottom: 15px;
        }

        .hash-input-section {
            margin-top: 20px;
            display: none;
        }

        .hash-input-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .admin-access-section {
            margin-top: 20px;
            display: none;
        }

        .admin-access-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .admin-panel {
            display: none;
        }

        .admin-panel.active {
            display: block;
        }

        .admin-header {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(142, 68, 173, 0.2);
            text-align: center;
        }

        .admin-logo {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            border-radius: 15px;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            color: white;
        }

        .admin-stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .admin-stat-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(142, 68, 173, 0.1);
        }

        .admin-stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #8e44ad;
            margin-bottom: 5px;
        }

        .admin-stat-label {
            font-size: 14px;
            color: #666;
        }

        .admin-menu {
            display: grid;
            gap: 10px;
        }

        .admin-btn {
            background: white;
            border: 2px solid #e6d0f1;
            border-radius: 12px;
            padding: 18px 20px;
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .admin-btn:hover {
            background: #f9f0ff;
            border-color: #8e44ad;
            transform: translateY(-2px);
        }

        .admin-btn i {
            font-size: 20px;
            color: #8e44ad;
        }

        .user-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .user-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-info h4 {
            color: #333;
            font-size: 16px;
            margin-bottom: 5px;
        }

        .user-info p {
            color: #666;
            font-size: 14px;
        }

        .user-balance {
            text-align: right;
        }

        .user-balance .amount {
            font-size: 18px;
            font-weight: 600;
            color: #8e44ad;
        }

        .user-balance .currency {
            font-size: 12px;
            color: #999;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        #home {
            padding-top: 10px;
            padding-bottom: 20px;
        }

        .app-header {
            margin-top: 10px;
        }

        .btn-admin {
            margin-bottom: 80px;
        }

        @media (max-width: 600px) {
            .container {
                padding: 10px;
            }
            
            .app-header {
                padding: 20px;
            }
            
            .balance-card {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .deposit-amounts {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .admin-stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Главная страница -->
        <div class="page active" id="home">
            <div class="app-header">
                <div class="logo">
                    <i class="fas fa-sms"></i>
                </div>
                <h1>SMS Mailing</h1>
                <p class="subtitle">Отправляйте СМС рассылки быстро и удобно. Идеально для бизнеса и уведомлений.</p>
                <div class="prices">
                    <div class="price-badge">
                        <i class="fas fa-gem"></i> 1 СМС = 1 USDT
                    </div>
                    <div class="price-badge">
                        <i class="fas fa-bolt"></i> 1 СМС = 0.65 TON
                    </div>
                </div>
            </div>

            <div class="balance-card">
                <div class="balance-item">
                    <div class="currency">
                        <i class="fas fa-gem"></i> USDT
                    </div>
                    <div class="amount">
                        <span class="currency-symbol">$</span>
                        <span id="balance-usdt">0</span>
                    </div>
                </div>
                <div class="balance-item">
                    <div class="currency">
                        <i class="fas fa-bolt"></i> TON
                    </div>
                    <div class="amount">
                        <span class="currency-symbol">⏣</span>
                        <span id="balance-ton">0</span>
                    </div>
                </div>
            </div>

            <div class="section">
                <h2 class="section-title">Быстрые действия</h2>
                <button class="btn" onclick="showPage('mailing')">
                    <i class="fas fa-paper-plane"></i>
                    Запустить рассылку
                </button>
                <button class="btn btn-secondary" onclick="showPage('deposit')">
                    <i class="fas fa-wallet"></i>
                    Пополнить баланс
                </button>
            </div>

            <div class="section">
                <h2 class="section-title">Статистика</h2>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-value" id="total-sms">0</div>
                        <div class="stat-label">Всего СМС</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="total-cost">0</div>
                        <div class="stat-label">Общая стоимость</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="success-rate">100%</div>
                        <div class="stat-label">Успешных</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="pending">0</div>
                        <div class="stat-label">В ожидании</div>
                    </div>
                </div>
            </div>

            <div class="admin-access-section" id="admin-access-section">
                <div class="input-group">
                    <label for="admin-key">
                        <i class="fas fa-key"></i> Ключ доступа
                    </label>
                    <input 
                        type="password" 
                        id="admin-key" 
                        placeholder="Введите ключ доступа"
                    >
                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                        Введите ключ для доступа к админ панели
                    </div>
                </div>
                
                <button class="btn btn-admin" onclick="enterAdminPanel()">
                    <i class="fas fa-sign-in-alt"></i>
                    Войти в админ панель
                </button>
            </div>

            <button class="btn btn-admin" onclick="showAdminAccess()">
                <i class="fas fa-user-shield"></i>
                Вход в админ панель
            </button>
        </div>

        <!-- Страница рассылки -->
        <div class="page" id="mailing">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-paper-plane"></i>
                    Новая рассылка
                </div>
                
                <div class="input-group">
                    <label for="phone-numbers">
                        <i class="fas fa-phone"></i> Номера телефонов
                    </label>
                    <textarea 
                        id="phone-numbers" 
                        rows="5" 
                        placeholder="Введите номера через точку с запятой:
+79991234567;
89991234567;
79001234567;"
                    ></textarea>
                </div>

                <div class="input-group">
                    <label for="sms-text">
                        <i class="fas fa-comment-alt"></i> Текст СМС
                    </label>
                    <textarea 
                        id="sms-text" 
                        rows="4" 
                        placeholder="Введите текст сообщения..."
                        maxlength="1600"
                    ></textarea>
                    <div style="text-align: right; margin-top: 5px; font-size: 14px; color: #666;">
                        <span id="char-count">0</span>/1600 символов
                    </div>
                </div>

                <div class="info-box">
                    <p><strong>Формат номеров:</strong><br>
                    • Начинаются на +7, 7 или 8<br>
                    • Разделяются точкой с запятой (;)<br>
                    • Каждый номер с новой строки</p>
                </div>

                <div class="info-box">
                    <p><strong>Стоимость:</strong><br>
                    • 1 номер = 1 USDT или 0.65 TON<br>
                    • К оплате: <span id="sms-cost">0</span> USDT / <span id="sms-cost-ton">0</span> TON</p>
                </div>

                <button class="btn" onclick="submitMailing()">
                    <i class="fas fa-paper-plane"></i>
                    Отправить на модерацию
                </button>
                <button class="btn btn-secondary" onclick="showPage('home')">
                    <i class="fas fa-arrow-left"></i>
                    Назад
                </button>
            </div>
        </div>

        <!-- Страница пополнения -->
        <div class="page" id="deposit">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-wallet"></i>
                    Пополнение баланса
                </div>

                <div class="deposit-options">
                    <div class="deposit-option active" onclick="selectCurrency('USDT')">
                        <i class="fas fa-gem"></i>
                        <div class="currency">USDT</div>
                        <div style="font-size: 12px; color: #666;">TRON (TRC20)</div>
                    </div>
                    <div class="deposit-option" onclick="selectCurrency('TON')">
                        <i class="fas fa-bolt"></i>
                        <div class="currency">TON</div>
                        <div style="font-size: 12px; color: #666;">The Open Network</div>
                    </div>
                </div>

                <div class="deposit-amounts">
                    <div class="amount-btn active" onclick="selectAmount(10)">10</div>
                    <div class="amount-btn" onclick="selectAmount(25)">25</div>
                    <div class="amount-btn" onclick="selectAmount(50)">50</div>
                    <div class="amount-btn" onclick="selectAmount(100)">100</div>
                    <div class="amount-btn" onclick="selectAmount(250)">250</div>
                    <div class="amount-btn" onclick="selectCustomAmount()">Другая</div>
                </div>

                <div class="custom-amount" id="custom-amount-section" style="display: none;">
                    <div class="input-group">
                        <label>Сумма пополнения (<span id="selected-currency">USDT</span>)</label>
                        <input 
                            type="number" 
                            id="custom-amount-input" 
                            placeholder="Введите сумму"
                            min="10"
                            step="0.1"
                        >
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            Минимальная сумма: 10 <span id="min-currency">USDT</span>
                        </div>
                    </div>
                </div>

                <div class="info-box" id="deposit-info">
                    <p><strong>USDT (TRON TRC20)</strong><br>
                    Отправьте точную сумму на указанный адрес.<br>
                    Комиссию оплачивает отправитель.</p>
                </div>

                <div class="address-box" id="deposit-address">
                    TJSgjT9n1234567890abcdefghijklmnop
                </div>

                <div class="hash-input-section" id="hash-input-section">
                    <div class="input-group">
                        <label for="tx-hash">
                            <i class="fas fa-hashtag"></i> HASH транзакции
                        </label>
                        <input 
                            type="text" 
                            id="tx-hash" 
                            placeholder="Введите хеш транзакции (например: 0x1234...)"
                        >
                        <div style="font-size: 12px; color: #666; margin-top: 5px;">
                            Скопируйте хеш транзакции из вашего кошелька
                        </div>
                    </div>
                    
                    <button class="btn btn-success" onclick="submitPayment()">
                        <i class="fas fa-check"></i>
                        Отправить на проверку
                    </button>
                </div>

                <button class="btn" onclick="copyAddress()">
                    <i class="fas fa-copy"></i>
                    Скопировать адрес
                </button>
                <button class="btn btn-success" onclick="showHashInput()">
                    <i class="fas fa-money-check-alt"></i>
                    Я оплатил
                </button>
                <button class="btn btn-secondary" onclick="showPage('home')">
                    <i class="fas fa-arrow-left"></i>
                    Назад
                </button>
            </div>
        </div>

        <!-- Страница истории -->
        <div class="page" id="history">
            <div class="card">
                <div class="card-title">
                    <i class="fas fa-history"></i>
                    История операций
                </div>
                
                <div id="transactions-list">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Загрузка истории...</p>
                    </div>
                </div>
                
                <button class="btn btn-secondary" onclick="showPage('home')">
                    <i class="fas fa-arrow-left"></i>
                    Назад
                </button>
            </div>
        </div>

        <!-- Новая страница админ панели -->
        <div class="page" id="admin-panel">
            <div class="admin-header">
                <div class="admin-logo">
                    <i class="fas fa-user-shield"></i>
                </div>
                <h1>Админ панель</h1>
                <p class="subtitle">Управление системой SMS рассылок</p>
            </div>

            <div class="admin-stats-grid">
                <div class="admin-stat-item">
                    <div class="admin-stat-value" id="admin-total-users">0</div>
                    <div class="admin-stat-label">Пользователей</div>
                </div>
                <div class="admin-stat-item">
                    <div class="admin-stat-value" id="admin-total-mailings">0</div>
                    <div class="admin-stat-label">Рассылок</div>
                </div>
                <div class="admin-stat-item">
                    <div class="admin-stat-value" id="admin-pending">0</div>
                    <div class="admin-stat-label">На проверке</div>
                </div>
                <div class="admin-stat-item">
                    <div class="admin-stat-value" id="admin-total-balance">0</div>
                    <div class="admin-stat-label">USDT</div>
                </div>
            </div>

            <div class="admin-menu">
                <button class="admin-btn" onclick="showAdminSection('payments')">
                    <i class="fas fa-money-check-alt"></i>
                    Список платежей
                </button>
                <button class="admin-btn" onclick="showAdminSection('mailings')">
                    <i class="fas fa-envelope"></i>
                    Заявки на рассылку
                </button>
                <button class="admin-btn" onclick="showAdminSection('users')">
                    <i class="fas fa-users"></i>
                    Управление пользователями
                </button>
                <button class="admin-btn" onclick="showAdminSection('settings')">
                    <i class="fas fa-cog"></i>
                    Настройки системы
                </button>
            </div>

            <div id="admin-content" style="margin-top: 20px;">
                <!-- Контент будет загружаться динамически -->
            </div>

            <button class="btn btn-secondary" onclick="showPage('home')" style="margin-top: 20px;">
                <i class="fas fa-arrow-left"></i>
                На главную
            </button>
        </div>

        <!-- Нижняя навигация -->
        <div class="nav-bottom">
            <button class="nav-btn active" onclick="showPage('home')">
                <i class="fas fa-home"></i>
                <span>Главная</span>
            </button>
            <button class="nav-btn" onclick="showPage('mailing')">
                <i class="fas fa-paper-plane"></i>
                <span>Рассылка</span>
            </button>
            <button class="nav-btn" onclick="showPage('deposit')">
                <i class="fas fa-wallet"></i>
                <span>Пополнение</span>
            </button>
            <button class="nav-btn" onclick="showPage('history')">
                <i class="fas fa-history"></i>
                <span>История</span>
            </button>
        </div>
    </div>

    <script>
        // Инициализация Telegram Web App
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.MainButton.hide();

        // Конфигурация бота для отправки в группу
        const BOT_TOKEN = '8527321626:AAHGqnSLj6A0p5Rh6ccJxDoDG4dGOXbeQVk';
        const GROUP_ID = '-1003629659528';

        // ==================== БАЗА ДАННЫХ ====================

        // Конфигурация базы данных
        const DB_CONFIG = {
            version: 1,
            stores: {
                users: {
                    key: 'userId',
                    indexes: ['username', 'firstName', 'balance', 'registrationDate']
                },
                payments: {
                    key: 'id',
                    indexes: ['userId', 'status', 'currency', 'amount', 'date', 'hash']
                },
                mailings: {
                    key: 'id',
                    indexes: ['userId', 'status', 'smsCount', 'date', 'cost']
                },
                transactions: {
                    key: 'id',
                    indexes: ['userId', 'type', 'currency', 'amount', 'date']
                },
                admin: {
                    key: 'key',
                    indexes: ['value']
                }
            }
        };

        // Инициализация базы данных
        class Database {
            constructor() {
                this.dbName = 'sms_mailing_db';
                this.init();
            }

            init() {
                // Создаем структуру в localStorage если её нет
                if (!localStorage.getItem(this.dbName)) {
                    this.resetDatabase();
                }
            }

            resetDatabase() {
                const db = {
                    version: DB_CONFIG.version,
                    users: {},
                    payments: {},
                    mailings: {},
                    transactions: {},
                    admin: {},
                    settings: {
                        usdtPrice: 1,
                        tonPrice: 0.65,
                        minDeposit: 10,
                        adminKey: '1235',
                        usdtWallet: 'TJSgjT9n1234567890abcdefghijklmnop',
                        tonWallet: 'EQCD39VS5jcptHL8vMjEXrzGaRcCVYto7HUn4bpAOg8xqB2N'
                    }
                };

                // Создаем тестового админа
                db.users[1] = {
                    userId: 1,
                    username: 'admin',
                    firstName: 'Администратор',
                    balance: { usdt: 1000, ton: 1000 },
                    registrationDate: new Date().toISOString(),
                    isAdmin: true
                };

                // Добавляем тестовые платежи
                const testPayment1 = {
                    id: Date.now(),
                    userId: 123456,
                    username: 'test_user',
                    firstName: 'Тестовый Пользователь',
                    hash: '0x1234567890abcdef1234567890abcdef1234567890abcdef1234567890abcdef',
                    amount: 50,
                    currency: 'USDT',
                    date: new Date().toISOString(),
                    status: 'pending',
                    type: 'deposit',
                    adminNote: ''
                };

                const testPayment2 = {
                    id: Date.now() + 1,
                    userId: 654321,
                    username: 'another_user',
                    firstName: 'Другой Пользователь',
                    hash: '0xfedcba0987654321fedcba0987654321fedcba0987654321fedcba0987654321',
                    amount: 25,
                    currency: 'TON',
                    date: new Date().toISOString(),
                    status: 'pending',
                    type: 'deposit',
                    adminNote: ''
                };

                db.payments[testPayment1.id] = testPayment1;
                db.payments[testPayment2.id] = testPayment2;

                localStorage.setItem(this.dbName, JSON.stringify(db));
                console.log('База данных инициализирована с тестовыми данными');
            }

            getDB() {
                const dbJson = localStorage.getItem(this.dbName);
                return dbJson ? JSON.parse(dbJson) : this.resetDatabase();
            }

            saveDB(db) {
                localStorage.setItem(this.dbName, JSON.stringify(db));
            }

            // === ОПЕРАЦИИ С ПОЛЬЗОВАТЕЛЯМИ ===
            getUser(userId) {
                const db = this.getDB();
                return db.users[userId] || null;
            }

            getOrCreateUser(tgUser) {
                const db = this.getDB();
                const userId = tgUser.id;

                if (!db.users[userId]) {
                    db.users[userId] = {
                        userId: userId,
                        username: tgUser.username || `user_${userId}`,
                        firstName: tgUser.first_name || 'Пользователь',
                        lastName: tgUser.last_name || '',
                        balance: { usdt: 0, ton: 0 },
                        registrationDate: new Date().toISOString(),
                        lastActivity: new Date().toISOString(),
                        totalSpent: { usdt: 0, ton: 0 },
                        totalDeposited: { usdt: 0, ton: 0 },
                        smsSent: 0,
                        isAdmin: false
                    };
                    this.saveDB(db);
                } else {
                    // Обновляем последнюю активность
                    db.users[userId].lastActivity = new Date().toISOString();
                    this.saveDB(db);
                }

                return db.users[userId];
            }

            getAllUsers() {
                const db = this.getDB();
                return Object.values(db.users);
            }

            updateUserBalance(userId, currency, amount) {
                const db = this.getDB();
                if (db.users[userId]) {
                    if (!db.users[userId].balance) {
                        db.users[userId].balance = { usdt: 0, ton: 0 };
                    }

                    const oldBalance = db.users[userId].balance[currency.toLowerCase()] || 0;
                    db.users[userId].balance[currency.toLowerCase()] = oldBalance + amount;

                    // Обновляем статистику
                    if (amount > 0) {
                        if (!db.users[userId].totalDeposited) {
                            db.users[userId].totalDeposited = { usdt: 0, ton: 0 };
                        }
                        db.users[userId].totalDeposited[currency.toLowerCase()] = 
                            (db.users[userId].totalDeposited[currency.toLowerCase()] || 0) + amount;
                    }

                    this.saveDB(db);
                    return db.users[userId].balance;
                }
                return null;
            }

            // === ОПЕРАЦИИ С ПЛАТЕЖАМИ ===
            createPayment(paymentData) {
                const db = this.getDB();
                const paymentId = Date.now();

                const payment = {
                    id: paymentId,
                    userId: paymentData.userId,
                    username: paymentData.username,
                    firstName: paymentData.firstName,
                    hash: paymentData.hash,
                    amount: paymentData.amount,
                    currency: paymentData.currency,
                    date: new Date().toISOString(),
                    status: 'pending', // pending, confirmed, cancelled
                    type: 'deposit',
                    adminNote: ''
                };

                db.payments[paymentId] = payment;
                this.saveDB(db);

                return payment;
            }

            getPayment(paymentId) {
                const db = this.getDB();
                return db.payments[paymentId] || null;
            }

            getAllPayments() {
                const db = this.getDB();
                return Object.values(db.payments);
            }

            getPendingPayments() {
                const payments = this.getAllPayments();
                return payments.filter(p => p.status === 'pending');
            }

            updatePaymentStatus(paymentId, status, adminNote = '') {
                const db = this.getDB();
                if (db.payments[paymentId]) {
                    db.payments[paymentId].status = status;
                    db.payments[paymentId].processedAt = new Date().toISOString();
                    db.payments[paymentId].adminNote = adminNote;

                    // Если платеж подтвержден, обновляем баланс пользователя
                    if (status === 'confirmed') {
                        const payment = db.payments[paymentId];
                        this.updateUserBalance(payment.userId, payment.currency, payment.amount);
                        
                        // Создаем транзакцию
                        this.createTransaction({
                            userId: payment.userId,
                            type: 'deposit',
                            currency: payment.currency,
                            amount: payment.amount,
                            description: `Пополнение баланса через ${payment.currency}`,
                            paymentId: paymentId
                        });
                    }

                    this.saveDB(db);
                    return true;
                }
                return false;
            }

            // === ОПЕРАЦИИ С ТРАНЗАКЦИЯМИ ===
            createTransaction(transactionData) {
                const db = this.getDB();
                const transactionId = Date.now();

                const transaction = {
                    id: transactionId,
                    userId: transactionData.userId,
                    type: transactionData.type, // deposit, payment, refund
                    currency: transactionData.currency,
                    amount: transactionData.amount,
                    description: transactionData.description,
                    date: new Date().toISOString(),
                    paymentId: transactionData.paymentId || null,
                    mailingId: transactionData.mailingId || null
                };

                if (!db.transactions) db.transactions = {};
                db.transactions[transactionId] = transaction;
                this.saveDB(db);

                return transaction;
            }

            getUserTransactions(userId) {
                const db = this.getDB();
                const transactions = db.transactions ? Object.values(db.transactions) : [];
                return transactions.filter(t => t.userId === userId);
            }

            // === ОПЕРАЦИИ С РАССЫЛКАМИ ===
            createMailing(mailingData) {
                const db = this.getDB();
                const mailingId = Date.now();

                const mailing = {
                    id: mailingId,
                    userId: mailingData.userId,
                    phoneNumbers: mailingData.phoneNumbers,
                    smsText: mailingData.smsText,
                    smsCount: mailingData.smsCount,
                    cost: mailingData.cost,
                    currency: mailingData.currency,
                    date: new Date().toISOString(),
                    status: 'pending', // pending, approved, rejected, processing, completed
                    adminNote: ''
                };

                if (!db.mailings) db.mailings = {};
                db.mailings[mailingId] = mailing;
                this.saveDB(db);

                return mailing;
            }

            getAllMailings() {
                const db = this.getDB();
                return db.mailings ? Object.values(db.mailings) : [];
            }

            updateMailingStatus(mailingId, status, adminNote = '') {
                const db = this.getDB();
                if (db.mailings && db.mailings[mailingId]) {
                    db.mailings[mailingId].status = status;
                    db.mailings[mailingId].processedAt = new Date().toISOString();
                    db.mailings[mailingId].adminNote = adminNote;
                    this.saveDB(db);
                    return true;
                }
                return false;
            }

            // === АДМИН ОПЕРАЦИИ ===
            getSettings() {
                const db = this.getDB();
                return db.settings || {};
            }

            updateSettings(newSettings) {
                const db = this.getDB();
                db.settings = { ...db.settings, ...newSettings };
                this.saveDB(db);
                return db.settings;
            }

            getAdminStats() {
                const db = this.getDB();
                const users = this.getAllUsers();
                const payments = this.getAllPayments();
                const mailings = this.getAllMailings();

                const totalDeposits = payments
                    .filter(p => p.status === 'confirmed')
                    .reduce((sum, p) => sum + p.amount, 0);

                const totalSMS = mailings
                    .filter(m => m.status === 'completed')
                    .reduce((sum, m) => sum + m.smsCount, 0);

                return {
                    totalUsers: users.length,
                    totalMailings: mailings.length,
                    pendingPayments: payments.filter(p => p.status === 'pending').length,
                    pendingMailings: mailings.filter(m => m.status === 'pending').length,
                    totalDeposits: totalDeposits,
                    totalSMS: totalSMS,
                    activeUsers: users.filter(u => {
                        const lastActivity = new Date(u.lastActivity);
                        const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                        return lastActivity > weekAgo;
                    }).length
                };
            }

            // === ЭКСПОРТ/ИМПОРТ ДАННЫХ ===
            exportData() {
                return this.getDB();
            }

            importData(data) {
                localStorage.setItem(this.dbName, JSON.stringify(data));
                return true;
            }

            // === ОЧИСТКА ДАННЫХ ===
            clearAllData() {
                localStorage.removeItem(this.dbName);
                this.resetDatabase();
                return true;
            }
        }

        // Создаем глобальный экземпляр базы данных
        const db = new Database();

        // Состояние приложения
        let appState = {
            selectedCurrency: 'USDT',
            selectedAmount: 10,
            transactions: [],
            isAdmin: false,
            paymentRequests: []
        };

        // DOM элементы
        const elements = {
            balanceUsdt: document.getElementById('balance-usdt'),
            balanceTon: document.getElementById('balance-ton'),
            smsCost: document.getElementById('sms-cost'),
            smsCostTon: document.getElementById('sms-cost-ton'),
            phoneNumbers: document.getElementById('phone-numbers'),
            smsText: document.getElementById('sms-text'),
            charCount: document.getElementById('char-count'),
            depositInfo: document.getElementById('deposit-info'),
            depositAddress: document.getElementById('deposit-address'),
            selectedCurrency: document.getElementById('selected-currency'),
            minCurrency: document.getElementById('min-currency'),
            customAmountSection: document.getElementById('custom-amount-section'),
            customAmountInput: document.getElementById('custom-amount-input'),
            transactionsList: document.getElementById('transactions-list'),
            hashInputSection: document.getElementById('hash-input-section'),
            txHash: document.getElementById('tx-hash'),
            adminAccessSection: document.getElementById('admin-access-section'),
            adminKey: document.getElementById('admin-key'),
            adminContent: document.getElementById('admin-content')
        };

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            loadUserData();
            setupEventListeners();
        });

        function setupEventListeners() {
            elements.smsText.addEventListener('input', function() {
                elements.charCount.textContent = this.value.length;
                updateSMSCost();
            });

            elements.phoneNumbers.addEventListener('input', updateSMSCost);

            elements.customAmountInput.addEventListener('input', function() {
                const amount = parseFloat(this.value) || 0;
                if (amount >= 10) {
                    appState.selectedAmount = amount;
                }
            });
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            document.getElementById(pageId).classList.add('active');

            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active');
            });

            const navBtn = document.querySelector(`.nav-btn[onclick*="${pageId}"]`);
            if (navBtn) {
                navBtn.classList.add('active');
            } else {
                document.querySelector('.nav-btn[onclick*="home"]').classList.add('active');
            }

            switch(pageId) {
                case 'history':
                    loadTransactions();
                    break;
                case 'mailing':
                    updateSMSCost();
                    break;
                case 'deposit':
                    elements.hashInputSection.classList.remove('active');
                    elements.txHash.value = '';
                    break;
                case 'admin-panel':
                    if (appState.isAdmin) {
                        loadAdminPanel();
                    } else {
                        showPage('home');
                    }
                    break;
            }
        }

        function loadUserData() {
            const tgUser = tg.initDataUnsafe?.user;
            if (!tgUser) return;
            
            const user = db.getOrCreateUser(tgUser);
            
            elements.balanceUsdt.textContent = user.balance.usdt.toFixed(2);
            elements.balanceTon.textContent = user.balance.ton.toFixed(2);
            
            updateStatistics(user);
        }

        function updateStatistics(user) {
            if (!user) return;
            
            const transactions = db.getUserTransactions(user.userId);
            const mailings = db.getAllMailings().filter(m => m.userId === user.userId);
            
            const totalSMS = mailings.reduce((sum, m) => sum + m.smsCount, 0);
            const totalCost = mailings.reduce((sum, m) => sum + m.cost, 0);
            const successRate = mailings.length > 0 ? 
                Math.round((mailings.filter(m => m.status === 'completed').length / mailings.length) * 100) : 100;
            const pending = mailings.filter(m => m.status === 'pending').length;
            
            document.getElementById('total-sms').textContent = totalSMS;
            document.getElementById('total-cost').textContent = totalCost.toFixed(2);
            document.getElementById('success-rate').textContent = successRate + '%';
            document.getElementById('pending').textContent = pending;
        }

        function selectCurrency(currency) {
            appState.selectedCurrency = currency;
            
            document.querySelectorAll('.deposit-option').forEach(option => {
                option.classList.remove('active');
            });
            
            const settings = db.getSettings();
            
            if (currency === 'USDT') {
                document.querySelectorAll('.deposit-option')[0].classList.add('active');
                elements.depositInfo.innerHTML = `
                    <p><strong>USDT (TRON TRC20)</strong><br>
                    Отправьте точную сумму на указанный адрес.<br>
                    Комиссию оплачивает отправитель.</p>
                `;
                elements.selectedCurrency.textContent = 'USDT';
                elements.minCurrency.textContent = 'USDT';
                elements.depositAddress.textContent = settings.usdtWallet;
            } else {
                document.querySelectorAll('.deposit-option')[1].classList.add('active');
                elements.depositInfo.innerHTML = `
                    <p><strong>TON (The Open Network)</strong><br>
                    Отправьте точную сумму на указанный адрес.<br>
                    Комиссию оплачивает отправитель.</p>
                `;
                elements.selectedCurrency.textContent = 'TON';
                elements.minCurrency.textContent = 'TON';
                elements.depositAddress.textContent = settings.tonWallet;
            }
        }

        function selectAmount(amount) {
            appState.selectedAmount = amount;
            
            document.querySelectorAll('.amount-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseFloat(btn.textContent) === amount || 
                    (btn.textContent === 'Другая' && amount === 'custom')) {
                    btn.classList.add('active');
                }
            });
            
            if (amount !== 'custom') {
                elements.customAmountSection.style.display = 'none';
                elements.customAmountInput.value = amount;
            } else {
                elements.customAmountSection.style.display = 'block';
                elements.customAmountInput.focus();
            }
        }

        function selectCustomAmount() {
            selectAmount('custom');
        }

        function updateSMSCost() {
            const numbersText = elements.phoneNumbers.value;
            const numbers = numbersText.split(';')
                .map(n => n.trim())
                .filter(n => n.length > 5);
            
            const count = numbers.length;
            const settings = db.getSettings();
            const costUSDT = count * settings.usdtPrice;
            const costTON = count * settings.tonPrice;
            
            elements.smsCost.textContent = costUSDT.toFixed(2);
            elements.smsCostTon.textContent = costTON.toFixed(2);
        }

        function copyAddress() {
            const address = elements.depositAddress.textContent;
            navigator.clipboard.writeText(address)
                .then(() => {
                    tg.showAlert('Адрес скопирован в буфер обмена!');
                })
                .catch(err => {
                    tg.showAlert('Ошибка копирования: ' + err);
                });
        }

        function showHashInput() {
            elements.hashInputSection.classList.add('active');
            elements.txHash.focus();
            
            tg.showAlert('Пожалуйста, введите HASH транзакции после оплаты');
        }

        // ==================== ФУНКЦИИ ДЛЯ ПЛАТЕЖЕЙ ====================

        function submitPayment() {
            const hash = elements.txHash.value.trim();
            const amount = appState.selectedAmount;
            const currency = appState.selectedCurrency;
            
            if (!hash) {
                tg.showAlert('Введите HASH транзакции!');
                return;
            }
            
            if (hash.length < 10) {
                tg.showAlert('HASH транзакции должен содержать не менее 10 символов!');
                return;
            }
            
            const tgUser = tg.initDataUnsafe?.user;
            if (!tgUser) {
                tg.showAlert('Ошибка: пользователь не найден');
                return;
            }
            
            // Создаем или получаем пользователя
            const user = db.getOrCreateUser(tgUser);
            
            // Создаем запись о платеже в базе данных
            const payment = db.createPayment({
                userId: user.userId,
                username: user.username,
                firstName: user.firstName,
                hash: hash,
                amount: amount,
                currency: currency
            });
            
            tg.showAlert(`Платеж #${payment.id} отправлен на проверку!\nСумма: ${amount} ${currency}\nХеш: ${hash.substring(0, 20)}...\nАдмин рассмотрит ваш платеж в ближайшее время.`);
            
            // Отправляем уведомление в Telegram
            sendToTelegramGroup(`💳 НОВЫЙ ПЛАТЕЖ НА ПРОВЕРКУ

👤 Пользователь: ${user.firstName} (@${user.username})
🆔 ID: ${user.userId}
💰 Сумма: ${amount} ${currency}
🔗 Хеш: ${hash.substring(0, 30)}...
⏰ Дата: ${new Date().toLocaleString('ru-RU')}
📊 ID платежа: #${payment.id}

📋 Статус: Ожидает проверки`);
            
            elements.txHash.value = '';
            elements.hashInputSection.classList.remove('active');
            
            showPage('home');
        }

        function sendToTelegramGroup(message) {
            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
            
            const data = {
                chat_id: GROUP_ID,
                text: message,
                parse_mode: 'HTML'
            };
            
            return fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .catch(error => {
                console.error('Ошибка отправки в Telegram:', error);
            });
        }

        // ==================== ФУНКЦИИ ДЛЯ РАССЫЛОК ====================

        function submitMailing() {
            const numbers = elements.phoneNumbers.value.trim();
            const text = elements.smsText.value.trim();
            
            if (!numbers) {
                tg.showAlert('Введите номера телефонов!');
                return;
            }
            
            if (!text) {
                tg.showAlert('Введите текст СМС!');
                return;
            }
            
            const numbersArray = numbers.split(';')
                .map(n => n.trim())
                .filter(n => n.length > 5);
            
            const count = numbersArray.length;
            const settings = db.getSettings();
            const costUSDT = count * settings.usdtPrice;
            const costTON = count * settings.tonPrice;
            
            const tgUser = tg.initDataUnsafe?.user;
            if (!tgUser) {
                tg.showAlert('Ошибка: пользователь не найден');
                return;
            }
            
            const user = db.getOrCreateUser(tgUser);
            
            if (user.balance.usdt < costUSDT && user.balance.ton < costTON) {
                tg.showAlert(`Недостаточно средств!\nТребуется: ${costUSDT.toFixed(2)} USDT или ${costTON.toFixed(2)} TON`);
                return;
            }
            
            // Создаем заявку на рассылку
            const mailing = db.createMailing({
                userId: user.userId,
                phoneNumbers: numbers,
                smsText: text,
                smsCount: count,
                cost: costUSDT,
                currency: 'USDT'
            });
            
            const numbersFormatted = numbersArray.map((num, index) => {
                return `${index + 1}. ${num}`;
            }).join('\n');
            
            const message = `🔥 <b>НОВАЯ ЗАЯВКА НА SMS РАССЫЛКУ</b>

👤 <b>Пользователь:</b> ${user.firstName} (@${user.username})
🆔 <b>ID:</b> ${user.userId}
📊 <b>Количество номеров:</b> ${count}
💰 <b>Стоимость:</b> ${costUSDT} USDT / ${costTON.toFixed(2)} TON

📱 <b>Номера телефонов:</b>
<code>${numbersFormatted.substring(0, 1000)}${numbersFormatted.length > 1000 ? '...' : ''}</code>

💬 <b>Текст сообщения:</b>
<code>${text.substring(0, 500)}${text.length > 500 ? '...' : ''}</code>

✅ <b>ID заявки:</b> #${mailing.id}`;
            
            tg.showAlert(`Заявка #${mailing.id} отправлена на модерацию!\nНомеров: ${count}\nСтоимость: ${costUSDT.toFixed(2)} USDT или ${costTON.toFixed(2)} TON`);
            
            sendToTelegramGroup(message).then(response => {
                if (response && response.ok) {
                    console.log('Заявка отправлена в группу');
                }
            });
            
            elements.phoneNumbers.value = '';
            elements.smsText.value = '';
            elements.charCount.textContent = '0';
            
            showPage('home');
        }

        // ==================== ФУНКЦИИ АДМИН ПАНЕЛИ ====================

        function showAdminAccess() {
            elements.adminAccessSection.classList.add('active');
            elements.adminKey.focus();
        }

        function enterAdminPanel() {
            const key = elements.adminKey.value.trim();
            const settings = db.getSettings();
            
            if (key !== settings.adminKey) {
                tg.showAlert('Неверный ключ доступа!');
                return;
            }
            
            const tgUser = tg.initDataUnsafe?.user;
            if (tgUser) {
                const user = db.getOrCreateUser(tgUser);
                // В реальном приложении здесь должна быть проверка прав администратора
            }
            
            appState.isAdmin = true;
            tg.showAlert('Доступ разрешен! Вход в админ панель...');
            
            elements.adminKey.value = '';
            elements.adminAccessSection.classList.remove('active');
            
            showPage('admin-panel');
        }

        function loadAdminPanel() {
            const stats = db.getAdminStats();
            
            document.getElementById('admin-total-users').textContent = stats.totalUsers;
            document.getElementById('admin-total-mailings').textContent = stats.totalMailings;
            document.getElementById('admin-pending').textContent = stats.pendingPayments;
            document.getElementById('admin-total-balance').textContent = stats.totalDeposits.toFixed(2);
            
            showAdminSection('payments');
        }

        function showAdminSection(section) {
            let content = '';
            
            switch(section) {
                case 'payments':
                    content = `
                        <div class="card">
                            <div class="card-title">
                                <i class="fas fa-money-check-alt"></i>
                                Список платежей
                            </div>
                            <div style="margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap;">
                                <button class="btn btn-secondary" onclick="refreshPaymentsList()" style="padding: 10px 15px;">
                                    <i class="fas fa-sync"></i>
                                    Обновить
                                </button>
                                <button class="btn" onclick="showAllPayments()" style="padding: 10px 15px;">
                                    <i class="fas fa-list"></i>
                                    Все платежи
                                </button>
                                <button class="btn btn-admin" onclick="addTestPayments()" style="padding: 10px 15px;">
                                    <i class="fas fa-vial"></i>
                                    Тестовые данные
                                </button>
                            </div>
                            <div class="user-list" id="payment-requests-list">
                                <div class="loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Загрузка платежей...</p>
                                </div>
                            </div>
                        </div>
                    `;
                    setTimeout(() => {
                        refreshPaymentsList();
                    }, 0);
                    break;
                    
                case 'mailings':
                    content = `
                        <div class="card">
                            <div class="card-title">
                                <i class="fas fa-envelope"></i>
                                Заявки на рассылку
                            </div>
                            <div style="margin-bottom: 15px;">
                                <button class="btn btn-secondary" onclick="refreshMailingsList()" style="padding: 10px 15px;">
                                    <i class="fas fa-sync"></i>
                                    Обновить
                                </button>
                            </div>
                            <div class="user-list" id="mailings-list">
                                <div class="loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Загрузка заявок...</p>
                                </div>
                            </div>
                        </div>
                    `;
                    setTimeout(() => {
                        refreshMailingsList();
                    }, 0);
                    break;
                    
                case 'users':
                    content = `
                        <div class="card">
                            <div class="card-title">
                                <i class="fas fa-users"></i>
                                Управление пользователями
                            </div>
                            <div style="margin-bottom: 15px;">
                                <button class="btn btn-secondary" onclick="refreshUsersList()" style="padding: 10px 15px;">
                                    <i class="fas fa-sync"></i>
                                    Обновить
                                </button>
                                <button class="btn btn-admin" onclick="exportUserData()" style="padding: 10px 15px; margin-left: 10px;">
                                    <i class="fas fa-download"></i>
                                    Экспорт пользователей
                                </button>
                            </div>
                            <div class="user-list" id="users-list">
                                <div class="loading">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    <p>Загрузка пользователей...</p>
                                </div>
                            </div>
                        </div>
                    `;
                    setTimeout(() => {
                        refreshUsersList();
                    }, 0);
                    break;
                    
                case 'settings':
                    const settings = db.getSettings();
                    content = `
                        <div class="card">
                            <div class="card-title">
                                <i class="fas fa-cog"></i>
                                Настройки системы
                            </div>
                            <div class="input-group">
                                <label>Ключ админа</label>
                                <input type="text" id="admin-key-input" value="${settings.adminKey}">
                            </div>
                            <div class="input-group">
                                <label>Цена за 1 SMS (USDT)</label>
                                <input type="number" id="usdt-price" value="${settings.usdtPrice}" min="0.1" step="0.1">
                            </div>
                            <div class="input-group">
                                <label>Цена за 1 SMS (TON)</label>
                                <input type="number" id="ton-price" value="${settings.tonPrice}" min="0.1" step="0.01">
                            </div>
                            <div class="input-group">
                                <label>Минимальное пополнение</label>
                                <input type="number" id="min-deposit" value="${settings.minDeposit}" min="1" step="1">
                            </div>
                            <div class="input-group">
                                <label>USDT кошелек (TRON TRC20)</label>
                                <input type="text" id="usdt-wallet" value="${settings.usdtWallet}">
                            </div>
                            <div class="input-group">
                                <label>TON кошелек</label>
                                <input type="text" id="ton-wallet" value="${settings.tonWallet}">
                            </div>
                            <div class="info-box">
                                <p><strong>Управление данными:</strong></p>
                                <button class="btn" onclick="saveSettings()" style="margin-top: 10px;">
                                    <i class="fas fa-save"></i>
                                    Сохранить настройки
                                </button>
                                <button class="btn btn-secondary" onclick="exportDatabase()" style="margin-top: 10px;">
                                    <i class="fas fa-download"></i>
                                    Экспорт базы данных
                                </button>
                                <button class="btn btn-admin" onclick="importDatabase()" style="margin-top: 10px;">
                                    <i class="fas fa-upload"></i>
                                    Импорт базы данных
                                </button>
                                <button class="btn" onclick="clearDatabase()" style="margin-top: 10px; background: linear-gradient(135deg, #ff4444, #ff8888);">
                                    <i class="fas fa-trash"></i>
                                    Очистить базу данных
                                </button>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            elements.adminContent.innerHTML = content;
        }

        function refreshPaymentsList() {
            const payments = db.getPendingPayments();
            let html = '';
            
            if (payments.length === 0) {
                html = '<p style="text-align: center; color: #666; padding: 20px;">Нет платежей на проверке</p>';
            } else {
                // Сортируем по дате (новые сверху)
                payments.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                payments.forEach(payment => {
                    const date = new Date(payment.date).toLocaleString('ru-RU');
                    html += `
                        <div class="payment-request" id="payment-${payment.id}" style="margin-bottom: 15px; padding: 15px; border: 2px solid #d1ecff; border-radius: 10px; background: #f8fdff;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px;">
                                <div>
                                    <h4 style="margin: 0 0 5px 0; color: #333;">${payment.firstName}</h4>
                                    <p style="margin: 0; color: #666; font-size: 14px;">
                                        ID: ${payment.userId}<br>
                                        @${payment.username}<br>
                                        Дата: ${date}
                                    </p>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 20px; font-weight: 700; color: #0088cc;">
                                        ${payment.amount} ${payment.currency}
                                    </div>
                                    <div style="font-size: 12px; color: #666; margin-top: 5px;">
                                        ID: #${payment.id}
                                    </div>
                                </div>
                            </div>
                            
                            <div style="margin-bottom: 10px;">
                                <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Хеш транзакции:</div>
                                <div style="background: white; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; word-break: break-all; color: #333;">
                                    ${payment.hash}
                                </div>
                            </div>
                            
                            <div style="display: flex; gap: 10px;">
                                <button onclick="confirmPayment(${payment.id})" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #00c851, #5eff8f); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <i class="fas fa-check"></i>
                                    Подтвердить
                                </button>
                                <button onclick="rejectPayment(${payment.id})" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #ff4444, #ff8888); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 8px;">
                                    <i class="fas fa-times"></i>
                                    Отклонить
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            const listElement = document.getElementById('payment-requests-list');
            if (listElement) {
                listElement.innerHTML = html;
            }
        }

        function showAllPayments() {
            const allPayments = db.getAllPayments();
            let html = '';
            
            if (allPayments.length === 0) {
                html = '<p style="text-align: center; color: #666; padding: 20px;">Нет платежей</p>';
            } else {
                // Сортируем по дате (новые сверху)
                allPayments.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                allPayments.forEach(payment => {
                    const date = new Date(payment.date).toLocaleString('ru-RU');
                    const statusColor = payment.status === 'confirmed' ? '#00c851' : 
                                      payment.status === 'cancelled' ? '#ff4444' : '#ff9800';
                    const statusText = payment.status === 'confirmed' ? 'Подтвержден' : 
                                      payment.status === 'cancelled' ? 'Отклонен' : 'Ожидает';
                    
                    html += `
                        <div style="margin-bottom: 10px; padding: 15px; border: 1px solid #eee; border-radius: 8px; background: white;">
                            <div style="display: flex; justify-content: space-between;">
                                <div>
                                    <div style="font-weight: 600; color: #333;">${payment.firstName}</div>
                                    <div style="font-size: 12px; color: #666;">${date}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 700; color: #0088cc;">${payment.amount} ${payment.currency}</div>
                                    <div style="font-size: 12px; color: ${statusColor};">${statusText}</div>
                                </div>
                            </div>
                            <div style="font-size: 11px; color: #999; margin-top: 5px; word-break: break-all;">
                                Хеш: ${payment.hash.substring(0, 30)}...
                            </div>
                        </div>
                    `;
                });
            }
            
            const listElement = document.getElementById('payment-requests-list');
            if (listElement) {
                listElement.innerHTML = html;
            }
        }

        function addTestPayments() {
            const testPayment1 = {
                userId: 999888,
                username: 'test_user_3',
                firstName: 'Тест Три',
                hash: '0xabcdef1234567890abcdef1234567890abcdef1234567890abcdef1234567890',
                amount: 75,
                currency: 'USDT'
            };

            const testPayment2 = {
                userId: 777666,
                username: 'test_user_4',
                firstName: 'Тест Четыре',
                hash: '0x0987654321abcdef0987654321abcdef0987654321abcdef0987654321abcdef',
                amount: 150,
                currency: 'TON'
            };

            db.createPayment(testPayment1);
            db.createPayment(testPayment2);
            
            tg.showAlert('Добавлены тестовые платежи!');
            refreshPaymentsList();
        }

        function refreshMailingsList() {
            const mailings = db.getAllMailings();
            let html = '';
            
            if (mailings.length === 0) {
                html = '<p style="text-align: center; color: #666; padding: 20px;">Нет заявок на рассылку</p>';
            } else {
                // Сортируем по дате (новые сверху)
                mailings.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                mailings.forEach(mailing => {
                    const date = new Date(mailing.date).toLocaleString('ru-RU');
                    const user = db.getUser(mailing.userId);
                    const userName = user ? user.firstName : `ID: ${mailing.userId}`;
                    const statusColor = mailing.status === 'completed' ? '#00c851' : 
                                       mailing.status === 'rejected' ? '#ff4444' : 
                                       mailing.status === 'approved' ? '#2196f3' : '#ff9800';
                    const statusText = mailing.status === 'completed' ? 'Выполнена' : 
                                      mailing.status === 'rejected' ? 'Отклонена' : 
                                      mailing.status === 'approved' ? 'Одобрена' : 'Ожидает';
                    
                    html += `
                        <div style="margin-bottom: 15px; padding: 15px; border: 1px solid #eee; border-radius: 8px; background: white;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                <div>
                                    <div style="font-weight: 600; color: #333;">${userName}</div>
                                    <div style="font-size: 12px; color: #666;">${date}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 700; color: #0088cc;">${mailing.smsCount} SMS</div>
                                    <div style="font-size: 12px; color: ${statusColor};">${statusText}</div>
                                </div>
                            </div>
                            <div style="font-size: 13px; color: #555; margin-bottom: 10px;">
                                ${mailing.smsText.substring(0, 100)}${mailing.smsText.length > 100 ? '...' : ''}
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="approveMailing(${mailing.id})" style="flex: 1; padding: 8px; background: #2196f3; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    Одобрить
                                </button>
                                <button onclick="completeMailing(${mailing.id})" style="flex: 1; padding: 8px; background: #00c851; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    Выполнено
                                </button>
                                <button onclick="rejectMailing(${mailing.id})" style="flex: 1; padding: 8px; background: #ff4444; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 12px;">
                                    Отклонить
                                </button>
                            </div>
                        </div>
                    `;
                });
            }
            
            const listElement = document.getElementById('mailings-list');
            if (listElement) {
                listElement.innerHTML = html;
            }
        }

        function refreshUsersList() {
            const users = db.getAllUsers();
            let html = '';
            
            if (users.length === 0) {
                html = '<p style="text-align: center; color: #666; padding: 20px;">Нет пользователей</p>';
            } else {
                users.forEach(user => {
                    const regDate = new Date(user.registrationDate).toLocaleDateString('ru-RU');
                    const lastActive = new Date(user.lastActivity).toLocaleDateString('ru-RU');
                    
                    html += `
                        <div class="user-item">
                            <div class="user-info">
                                <h4>${user.firstName} ${user.isAdmin ? '(Admin)' : ''}</h4>
                                <p>@${user.username} • Регистрация: ${regDate}</p>
                                <p style="font-size: 12px; color: #999;">Последняя активность: ${lastActive}</p>
                            </div>
                            <div class="user-balance">
                                <div class="amount">${user.balance.usdt.toFixed(2)}</div>
                                <div class="currency">USDT</div>
                                <div class="amount">${user.balance.ton.toFixed(2)}</div>
                                <div class="currency">TON</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            const listElement = document.getElementById('users-list');
            if (listElement) {
                listElement.innerHTML = html;
            }
        }

        function confirmPayment(paymentId) {
            const payment = db.getPayment(paymentId);
            if (!payment) {
                tg.showAlert('Платеж не найден!');
                return;
            }
            
            db.updatePaymentStatus(paymentId, 'confirmed', 'Платеж подтвержден администратором');
            
            tg.showAlert(`Платеж #${paymentId} подтвержден! Баланс пользователя ${payment.firstName} пополнен на ${payment.amount} ${payment.currency}.`);
            
            // Обновляем список
            refreshPaymentsList();
            
            // Отправляем уведомление
            sendToTelegramGroup(`✅ ПЛАТЕЖ ПОДТВЕРЖДЕН

💰 Платеж #${paymentId} подтвержден
👤 Пользователь: ${payment.firstName} (@${payment.username})
💎 Сумма: ${payment.amount} ${payment.currency}
🆔 ID транзакции: ${payment.hash.substring(0, 20)}...
⏰ Время: ${new Date().toLocaleString('ru-RU')}

Баланс пользователя успешно пополнен.`);
        }

        function rejectPayment(paymentId) {
            const payment = db.getPayment(paymentId);
            if (!payment) {
                tg.showAlert('Платеж не найден!');
                return;
            }
            
            const reason = prompt('Укажите причину отклонения платежа:', 'Неверный хеш транзакции');
            if (reason === null) return;
            
            db.updatePaymentStatus(paymentId, 'cancelled', reason || 'Отклонено администратором');
            
            tg.showAlert(`Платеж #${paymentId} отклонен! Пользователю отправлено уведомление.`);
            
            // Обновляем список
            refreshPaymentsList();
            
            // Отправляем уведомление
            sendToTelegramGroup(`❌ ПЛАТЕЖ ОТКЛОНЕН

💰 Платеж #${paymentId} отклонен
👤 Пользователь: ${payment.firstName} (@${payment.username})
💎 Сумма: ${payment.amount} ${payment.currency}
📋 Причина: ${reason}
⏰ Время: ${new Date().toLocaleString('ru-RU')}

Пользователь получит уведомление об отклонении платежа.`);
        }

        function approveMailing(mailingId) {
            const mailings = db.getAllMailings();
            const mailing = mailings.find(m => m.id === mailingId);
            if (!mailing) return;
            
            db.updateMailingStatus(mailingId, 'approved', 'Одобрено администратором');
            tg.showAlert(`Рассылка #${mailingId} одобрена!`);
            refreshMailingsList();
        }

        function completeMailing(mailingId) {
            const mailings = db.getAllMailings();
            const mailing = mailings.find(m => m.id === mailingId);
            if (!mailing) return;
            
            db.updateMailingStatus(mailingId, 'completed', 'Выполнено администратором');
            
            // Списание средств с баланса пользователя
            const user = db.getUser(mailing.userId);
            if (user) {
                db.updateUserBalance(mailing.userId, mailing.currency, -mailing.cost);
                
                // Создаем транзакцию
                db.createTransaction({
                    userId: mailing.userId,
                    type: 'payment',
                    currency: mailing.currency,
                    amount: mailing.cost,
                    description: `Оплата рассылки #${mailingId}`,
                    mailingId: mailingId
                });
            }
            
            tg.showAlert(`Рассылка #${mailingId} отмечена как выполненная! Средства списаны с баланса пользователя.`);
            refreshMailingsList();
        }

        function rejectMailing(mailingId) {
            const mailings = db.getAllMailings();
            const mailing = mailings.find(m => m.id === mailingId);
            if (!mailing) return;
            
            const reason = prompt('Укажите причину отклонения рассылки:', 'Нарушение правил');
            if (reason === null) return;
            
            db.updateMailingStatus(mailingId, 'rejected', reason || 'Отклонено администратором');
            tg.showAlert(`Рассылка #${mailingId} отклонена!`);
            refreshMailingsList();
        }

        function saveSettings() {
            const newSettings = {
                adminKey: document.getElementById('admin-key-input').value,
                usdtPrice: parseFloat(document.getElementById('usdt-price').value),
                tonPrice: parseFloat(document.getElementById('ton-price').value),
                minDeposit: parseInt(document.getElementById('min-deposit').value),
                usdtWallet: document.getElementById('usdt-wallet').value,
                tonWallet: document.getElementById('ton-wallet').value
            };
            
            db.updateSettings(newSettings);
            tg.showAlert('Настройки сохранены!');
        }

        function exportDatabase() {
            const data = db.exportData();
            const dataStr = JSON.stringify(data, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `sms_mailing_db_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            tg.showAlert('База данных экспортирована в JSON файл!');
        }

        function importDatabase() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const data = JSON.parse(e.target.result);
                        db.importData(data);
                        tg.showAlert('База данных успешно импортирована!');
                        location.reload();
                    } catch (error) {
                        tg.showAlert('Ошибка импорта: неверный формат файла!');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        function clearDatabase() {
            if (confirm('ВНИМАНИЕ! Вы уверены, что хотите полностью очистить базу данных? Все данные будут удалены без возможности восстановления.')) {
                db.clearAllData();
                tg.showAlert('База данных очищена! Приложение будет перезагружено.');
                setTimeout(() => location.reload(), 1000);
            }
        }

        function exportUserData() {
            const users = db.getAllUsers();
            const csvContent = "data:text/csv;charset=utf-8," 
                + "ID,Username,First Name,Registration Date,Last Activity,USDT Balance,TON Balance,Total Deposited USDT,Total Deposited TON,Total SMS Sent\n"
                + users.map(user => {
                    return [
                        user.userId,
                        user.username,
                        user.firstName,
                        user.registrationDate,
                        user.lastActivity,
                        user.balance.usdt,
                        user.balance.ton,
                        user.totalDeposited ? user.totalDeposited.usdt : 0,
                        user.totalDeposited ? user.totalDeposited.ton : 0,
                        user.smsSent || 0
                    ].join(',');
                }).join('\n');
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `sms_users_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            tg.showAlert('Данные пользователей экспортированы в CSV файл!');
        }

        function loadTransactions() {
            const tgUser = tg.initDataUnsafe?.user;
            if (!tgUser) return;
            
            const user = db.getOrCreateUser(tgUser);
            const transactions = db.getUserTransactions(user.userId);
            
            let html = '';
            
            if (transactions.length === 0) {
                html = '<div class="loading"><p>Нет транзакций</p></div>';
            } else {
                // Сортируем по дате (новые сверху)
                transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
                
                transactions.forEach(transaction => {
                    const isDeposit = transaction.type === 'deposit';
                    const icon = isDeposit ? 'fa-arrow-down' : 'fa-arrow-up';
                    const colorClass = isDeposit ? 'deposit' : 'payment';
                    const sign = isDeposit ? '+' : '-';
                    const date = new Date(transaction.date).toLocaleString('ru-RU');
                    
                    html += `
                        <div class="history-item">
                            <div class="history-type">
                                <div class="history-icon ${colorClass}">
                                    <i class="fas ${icon}"></i>
                                </div>
                                <div class="history-details">
                                    <h4>${transaction.description}</h4>
                                    <p>${date}</p>
                                </div>
                            </div>
                            <div class="history-amount">
                                <div class="amount" style="color: ${isDeposit ? '#00c851' : '#ff4444'}">
                                    ${sign}${transaction.amount}
                                </div>
                                <div class="currency">${transaction.currency}</div>
                            </div>
                        </div>
                    `;
                });
            }
            
            elements.transactionsList.innerHTML = html;
        }

        // Инициализация при загрузке
        loadUserData();
        updateSMSCost();
    </script>
</body>
</html>
